{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://otterblade-odyssey.game/schemas/chapter.json",
  "title": "Chapter Manifest Schema",
  "description": "Complete definition of a game chapter including level design, story, NPCs, quests, and media",
  "type": "object",
  "required": ["id", "name", "location", "narrative", "level", "media"],
  "properties": {
    "id": {
      "type": "integer",
      "minimum": 0,
      "maximum": 9,
      "description": "Chapter number (0 = Prologue, 9 = Epilogue)"
    },
    "name": {
      "type": "string",
      "description": "Chapter title (e.g., 'The Gatehouse')"
    },
    "location": {
      "type": "string", 
      "description": "Where this chapter takes place (e.g., 'Northern Gate')"
    },

    "narrative": {
      "type": "object",
      "description": "Story and emotional content",
      "required": ["theme", "quest", "emotionalArc"],
      "properties": {
        "theme": {
          "type": "string",
          "description": "Core theme (e.g., 'First test of courage')"
        },
        "quest": {
          "type": "string",
          "description": "Player's objective in storybook phrasing (e.g., 'Cross the Threshold')"
        },
        "emotionalArc": {
          "type": "object",
          "properties": {
            "opening": { "type": "string", "description": "How the chapter feels at start" },
            "midpoint": { "type": "string", "description": "The turn/challenge" },
            "climax": { "type": "string", "description": "The peak moment" },
            "resolution": { "type": "string", "description": "How it settles" }
          }
        },
        "storyBeats": {
          "type": "array",
          "description": "Key narrative moments (wordless, shown through action)",
          "items": {
            "type": "object",
            "properties": {
              "id": { "type": "string" },
              "moment": { "type": "string", "description": "What happens" },
              "triggeredBy": { "type": "string", "description": "Trigger ID that activates this" },
              "expression": { 
                "type": "string", 
                "enum": ["determination", "fear", "hope", "sorrow", "triumph", "wonder", "resolve"],
                "description": "Finn's emotional state (for animation)"
              }
            }
          }
        }
      }
    },

    "connections": {
      "type": "object",
      "description": "How this chapter connects to the larger story",
      "properties": {
        "previousChapter": { "type": ["integer", "null"] },
        "nextChapter": { "type": ["integer", "null"] },
        "transitionIn": {
          "type": "object",
          "properties": {
            "type": { "type": "string", "enum": ["cinematic", "fade", "walk_in", "wake_up"] },
            "cinematicId": { "type": "string" },
            "playerSpawnPoint": { "$ref": "#/definitions/point" }
          }
        },
        "transitionOut": {
          "type": "object", 
          "properties": {
            "type": { "type": "string", "enum": ["cinematic", "fade", "walk_out", "victory"] },
            "cinematicId": { "type": "string" },
            "exitPoint": { "$ref": "#/definitions/point" }
          }
        },
        "unlockRequirements": {
          "type": "array",
          "description": "What must be done to access this chapter",
          "items": {
            "type": "object",
            "properties": {
              "type": { "type": "string", "enum": ["complete_chapter", "collect_item", "defeat_boss", "find_secret"] },
              "value": { "type": ["string", "integer"] }
            }
          }
        }
      }
    },

    "npcs": {
      "type": "array",
      "description": "Non-player characters in this chapter",
      "items": { "$ref": "#/definitions/npc" }
    },

    "quests": {
      "type": "array",
      "description": "Objectives within this chapter",
      "items": { "$ref": "#/definitions/quest" }
    },

    "level": {
      "type": "object",
      "description": "Physical level design",
      "required": ["bounds", "segments"],
      "properties": {
        "bounds": {
          "type": "object",
          "properties": {
            "startX": { "type": "number" },
            "endX": { "type": "number" },
            "minY": { "type": "number" },
            "maxY": { "type": "number" }
          }
        },
        "biome": {
          "type": "string",
          "enum": ["village", "forest", "gatehouse", "great_hall", "library", "dungeon", "courtyard", "rooftops", "ramparts", "hearth"]
        },
        "segments": {
          "type": "array",
          "items": { "$ref": "#/definitions/levelSegment" }
        },
        "checkpoints": {
          "type": "array",
          "items": { "$ref": "#/definitions/checkpoint" }
        },
        "spawnPoint": { "$ref": "#/definitions/point" }
      }
    },

    "encounters": {
      "type": "array",
      "description": "Enemy placements (designed, not random!)",
      "items": { "$ref": "#/definitions/encounter" }
    },

    "boss": {
      "oneOf": [
        { "type": "null" },
        { "$ref": "#/definitions/bossFight" }
      ]
    },

    "interactions": {
      "type": "array",
      "description": "Interactive objects",
      "items": { "$ref": "#/definitions/interaction" }
    },

    "triggers": {
      "type": "array",
      "description": "Event triggers for story/gameplay",
      "items": { "$ref": "#/definitions/trigger" }
    },

    "collectibles": {
      "type": "array",
      "items": { "$ref": "#/definitions/collectible" }
    },

    "secrets": {
      "type": "array",
      "description": "Hidden areas and bonus content",
      "items": { "$ref": "#/definitions/secret" }
    },

    "media": {
      "type": "object",
      "description": "Rich media assets for this chapter",
      "properties": {
        "chapterPlate": {
          "type": "string",
          "description": "Reference to chapter plate asset ID"
        },
        "parallaxBackground": {
          "type": "string",
          "description": "Reference to parallax background asset ID"
        },
        "introCinematic": {
          "type": ["string", "null"],
          "description": "Reference to intro cinematic asset ID"
        },
        "outroCinematic": {
          "type": ["string", "null"],
          "description": "Reference to outro cinematic asset ID"
        },
        "bossIntroCinematic": {
          "type": ["string", "null"]
        },
        "musicTracks": {
          "type": "object",
          "properties": {
            "exploration": { "type": "string" },
            "tension": { "type": "string" },
            "combat": { "type": "string" },
            "boss": { "type": "string" },
            "victory": { "type": "string" }
          }
        },
        "ambientSounds": {
          "type": "array",
          "items": { "type": "string" }
        }
      }
    },

    "environment": {
      "type": "object",
      "description": "Environmental settings",
      "properties": {
        "lighting": {
          "type": "object",
          "properties": {
            "ambientColor": { "type": "string" },
            "ambientIntensity": { "type": "number", "minimum": 0, "maximum": 1 },
            "warmthInfluence": { "type": "boolean", "description": "Does player warmth affect lighting?" }
          }
        },
        "weather": {
          "type": "object",
          "properties": {
            "type": { "type": "string", "enum": ["clear", "mist", "rain", "snow", "wind", "storm"] },
            "intensity": { "type": "number", "minimum": 0, "maximum": 1 },
            "affectsGameplay": { "type": "boolean" }
          }
        },
        "warmthDrain": {
          "type": "number",
          "description": "How fast warmth drains (0 = no drain, 1 = fast)",
          "minimum": 0,
          "maximum": 1
        },
        "particles": {
          "type": "array",
          "description": "Ambient particle effects",
          "items": {
            "type": "object",
            "properties": {
              "type": { "type": "string", "enum": ["fireflies", "dust", "snow", "leaves", "embers", "mist"] },
              "density": { "type": "number" },
              "region": { "$ref": "#/definitions/region" }
            }
          }
        }
      }
    }
  },

  "definitions": {
    "point": {
      "type": "object",
      "properties": {
        "x": { "type": "number" },
        "y": { "type": "number" }
      },
      "required": ["x", "y"]
    },

    "region": {
      "type": "object",
      "properties": {
        "x": { "type": "number" },
        "y": { "type": "number" },
        "width": { "type": "number" },
        "height": { "type": "number" }
      },
      "required": ["x", "y", "width", "height"]
    },

    "npc": {
      "type": "object",
      "required": ["id", "characterId", "position"],
      "properties": {
        "id": { "type": "string", "description": "Unique instance ID" },
        "characterId": { "type": "string", "description": "Reference to character asset" },
        "name": { "type": "string" },
        "role": { 
          "type": "string", 
          "enum": ["ally", "mentor", "quest_giver", "merchant", "ambient", "rescued"],
          "description": "NPC's narrative function"
        },
        "position": { "$ref": "#/definitions/point" },
        "facing": { "type": "string", "enum": ["left", "right"] },
        "behavior": {
          "type": "object",
          "properties": {
            "idle": { "type": "string", "enum": ["stand", "sit", "work", "patrol", "sleep"] },
            "patrolPath": { 
              "type": "array", 
              "items": { "$ref": "#/definitions/point" }
            },
            "interactRadius": { "type": "number" }
          }
        },
        "storyState": {
          "type": "object",
          "description": "How NPC changes based on story progress",
          "properties": {
            "initialState": { "type": "string" },
            "states": {
              "type": "object",
              "additionalProperties": {
                "type": "object",
                "properties": {
                  "animation": { "type": "string" },
                  "expression": { "type": "string" },
                  "canInteract": { "type": "boolean" },
                  "questAvailable": { "type": "string" }
                }
              }
            }
          }
        },
        "interactions": {
          "type": "array",
          "description": "What happens when player interacts (wordless!)",
          "items": {
            "type": "object",
            "properties": {
              "trigger": { "type": "string", "description": "Required trigger state" },
              "actions": {
                "type": "array",
                "items": { "$ref": "#/definitions/action" }
              },
              "gesture": {
                "type": "string",
                "enum": ["nod", "point", "wave", "bow", "shake_head", "beckon", "give_item", "receive_item", "salute"],
                "description": "NPC's wordless communication"
              },
              "finnResponse": {
                "type": "string", 
                "enum": ["nod", "bow", "salute", "receive", "give", "determined_look"],
                "description": "Finn's wordless response"
              }
            }
          }
        },
        "givesQuest": { "type": "string", "description": "Quest ID this NPC initiates" },
        "completesQuest": { "type": "string", "description": "Quest ID this NPC completes" }
      }
    },

    "quest": {
      "type": "object",
      "required": ["id", "name", "objectives"],
      "properties": {
        "id": { "type": "string" },
        "name": { "type": "string", "description": "Storybook-style quest name" },
        "type": {
          "type": "string",
          "enum": ["main", "side", "secret", "collection"]
        },
        "giver": { "type": "string", "description": "NPC ID who gives quest (or 'environment')" },
        "objectives": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "id": { "type": "string" },
              "description": { "type": "string" },
              "type": {
                "type": "string",
                "enum": ["reach_location", "defeat_enemies", "collect_items", "interact", "escort", "survive", "light_lanterns", "find_secret"]
              },
              "target": { "type": ["string", "integer"] },
              "count": { "type": "integer" },
              "optional": { "type": "boolean" }
            }
          }
        },
        "rewards": {
          "type": "object",
          "properties": {
            "emberShards": { "type": "integer" },
            "hearthstone": { "type": "boolean" },
            "bladeUpgrade": { "type": "boolean" },
            "achievement": { "type": "string" },
            "unlocks": { "type": "string", "description": "Unlocks a secret or area" }
          }
        },
        "completionTrigger": { "type": "string", "description": "Trigger ID that marks completion" }
      }
    },

    "levelSegment": {
      "type": "object",
      "required": ["id", "startX", "endX", "platforms"],
      "properties": {
        "id": { "type": "string" },
        "startX": { "type": "number" },
        "endX": { "type": "number" },
        "platforms": {
          "type": "array",
          "items": { "$ref": "#/definitions/platform" }
        },
        "walls": {
          "type": "array",
          "items": { "$ref": "#/definitions/solid" }
        },
        "ceilings": {
          "type": "array",
          "items": { "$ref": "#/definitions/solid" }
        },
        "semiSolids": {
          "type": "array",
          "description": "Can jump through from below",
          "items": { "$ref": "#/definitions/platform" }
        },
        "ladders": {
          "type": "array",
          "items": { "$ref": "#/definitions/climbable" }
        },
        "water": {
          "type": "array",
          "items": { "$ref": "#/definitions/waterZone" }
        },
        "killZones": {
          "type": "array",
          "items": { "$ref": "#/definitions/region" }
        },
        "scamperZones": {
          "type": "array",
          "description": "Areas requiring low profile (scamper/crawl)",
          "items": { "$ref": "#/definitions/region" }
        }
      }
    },

    "platform": {
      "type": "object",
      "properties": {
        "x": { "type": "number" },
        "y": { "type": "number" },
        "width": { "type": "number" },
        "height": { "type": "number", "default": 24 },
        "asset": { "type": "string", "description": "Platform visual asset" },
        "type": {
          "type": "string",
          "enum": ["stone", "wood", "bridge", "abbey_stone", "moss_stone", "ice", "crumbling"]
        },
        "properties": {
          "type": "object",
          "properties": {
            "slippery": { "type": "boolean" },
            "crumbles": { "type": "boolean" },
            "crumbleDelay": { "type": "number" },
            "moving": { "type": "boolean" },
            "movePath": { "type": "array", "items": { "$ref": "#/definitions/point" } },
            "moveSpeed": { "type": "number" }
          }
        }
      }
    },

    "solid": {
      "type": "object",
      "properties": {
        "x": { "type": "number" },
        "y": { "type": "number" },
        "width": { "type": "number" },
        "height": { "type": "number" },
        "asset": { "type": "string" },
        "destructible": { "type": "boolean" },
        "health": { "type": "integer" }
      }
    },

    "climbable": {
      "type": "object",
      "properties": {
        "x": { "type": "number" },
        "y": { "type": "number" },
        "height": { "type": "number" },
        "type": { "type": "string", "enum": ["ladder", "rope", "vine", "chain"] },
        "asset": { "type": "string" }
      }
    },

    "waterZone": {
      "type": "object",
      "properties": {
        "region": { "$ref": "#/definitions/region" },
        "depth": { "type": "string", "enum": ["shallow", "deep", "surface"] },
        "current": {
          "type": "object",
          "properties": {
            "direction": { "type": "string", "enum": ["left", "right"] },
            "strength": { "type": "number" }
          }
        },
        "warmsPlayer": { "type": "boolean", "description": "Hot spring?" }
      }
    },

    "encounter": {
      "type": "object",
      "properties": {
        "id": { "type": "string" },
        "enemyType": { "type": "string" },
        "position": { "$ref": "#/definitions/point" },
        "behavior": {
          "type": "object",
          "properties": {
            "type": { "type": "string", "enum": ["stationary", "patrol", "guard", "ambush", "chase"] },
            "patrolPath": { "type": "array", "items": { "$ref": "#/definitions/point" } },
            "guardRadius": { "type": "number" },
            "aggroRadius": { "type": "number" }
          }
        },
        "spawnedByTrigger": { "type": "string", "description": "Only spawns when trigger fires" },
        "difficulty": { "type": "string", "enum": ["easy", "medium", "hard", "elite"] }
      }
    },

    "bossFight": {
      "type": "object",
      "properties": {
        "bossId": { "type": "string", "description": "Reference to boss asset" },
        "name": { "type": "string" },
        "arena": { "$ref": "#/definitions/region" },
        "phases": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "healthThreshold": { "type": "number", "description": "% health to trigger phase" },
              "behavior": { "type": "string" },
              "adds": { "type": "array", "items": { "type": "string" } }
            }
          }
        },
        "entryCinematic": { "type": "string" },
        "defeatCinematic": { "type": "string" },
        "rewards": {
          "type": "object",
          "properties": {
            "emberShards": { "type": "integer" },
            "hearthstone": { "type": "boolean" },
            "achievement": { "type": "string" },
            "unlocksChapter": { "type": "integer" }
          }
        }
      }
    },

    "interaction": {
      "type": "object",
      "required": ["id", "type", "position"],
      "properties": {
        "id": { "type": "string" },
        "type": {
          "type": "string",
          "enum": ["lantern", "lever", "door", "chest", "bell", "shrine", "sign", "pressure_plate", "breakable", "pushable"]
        },
        "position": { "$ref": "#/definitions/point" },
        "asset": { "type": "string" },
        "activateRadius": { "type": "number" },
        "activateKey": { "type": "string", "default": "interact" },
        "initialState": { "type": "string" },
        "states": {
          "type": "object",
          "additionalProperties": {
            "type": "object",
            "properties": {
              "asset": { "type": "string" },
              "solid": { "type": "boolean" },
              "actions": { "type": "array", "items": { "$ref": "#/definitions/action" } }
            }
          }
        },
        "requires": {
          "type": "object",
          "properties": {
            "item": { "type": "string" },
            "trigger": { "type": "string" },
            "warmth": { "type": "number" }
          }
        },
        "linkedTo": {
          "type": "array",
          "description": "Other interactions this affects",
          "items": { "type": "string" }
        }
      }
    },

    "trigger": {
      "type": "object",
      "required": ["id", "type", "actions"],
      "properties": {
        "id": { "type": "string" },
        "type": {
          "type": "string",
          "enum": ["enter_region", "exit_region", "defeat_enemies", "collect_item", "interact", "timer", "warmth_threshold", "health_threshold"]
        },
        "region": { "$ref": "#/definitions/region" },
        "targetId": { "type": "string" },
        "threshold": { "type": "number" },
        "once": { "type": "boolean", "default": true },
        "requires": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Trigger IDs that must fire first"
        },
        "actions": {
          "type": "array",
          "items": { "$ref": "#/definitions/action" }
        }
      }
    },

    "action": {
      "type": "object",
      "required": ["type"],
      "properties": {
        "type": {
          "type": "string",
          "enum": [
            "spawn_enemies",
            "spawn_boss", 
            "play_cinematic",
            "close_door",
            "open_door",
            "show_toast",
            "unlock_checkpoint",
            "play_sound",
            "shake_screen",
            "change_music",
            "npc_action",
            "complete_quest",
            "give_item",
            "restore_warmth",
            "drain_warmth",
            "complete_chapter",
            "unlock_achievement",
            "camera_pan",
            "slow_motion",
            "particle_burst"
          ]
        },
        "target": { "type": "string" },
        "value": { "type": ["string", "number", "boolean", "array"] },
        "delay": { "type": "number", "description": "Delay in ms before action" }
      }
    },

    "collectible": {
      "type": "object",
      "properties": {
        "id": { "type": "string" },
        "type": { "type": "string", "enum": ["ember_shard", "hearthstone", "lore_fragment", "map_piece"] },
        "position": { "$ref": "#/definitions/point" },
        "hidden": { "type": "boolean" },
        "requiresTrigger": { "type": "string" }
      }
    },

    "secret": {
      "type": "object",
      "properties": {
        "id": { "type": "string" },
        "name": { "type": "string" },
        "type": { "type": "string", "enum": ["hidden_room", "shortcut", "bonus_area", "easter_egg"] },
        "entrance": { "$ref": "#/definitions/region" },
        "hint": { "type": "string", "description": "Subtle visual hint for players" },
        "rewards": {
          "type": "object",
          "properties": {
            "emberShards": { "type": "integer" },
            "achievement": { "type": "string" },
            "loreFragment": { "type": "string" }
          }
        }
      }
    },

    "checkpoint": {
      "type": "object",
      "properties": {
        "id": { "type": "string" },
        "position": { "$ref": "#/definitions/point" },
        "type": { "type": "string", "enum": ["hearth", "shrine", "bonfire"] },
        "requiresTrigger": { "type": "string" },
        "restoresWarmth": { "type": "boolean", "default": true },
        "restoresHealth": { "type": "boolean", "default": true }
      }
    }
  }
}
