{
  "$schema": "../schema/chapter-schema.json",
  "id": 3,
  "name": "Great Hall",
  "location": "Central Hearthhold",

  "narrative": {
    "theme": "Taking the oath - becoming part of something greater",
    "quest": "Defend the Great Hall",
    
    "emotionalArc": {
      "opening": "The Great Hall stretches before Finn, vast and ancient. Stone pillars rise to vaulted ceilings. The Everember burns at its heart.",
      "midpoint": "Friar Rowan speaks of the oath all defenders take. But before Finn can swear, the windows shatter. Galeborn inside the walls!",
      "climax": "Battle in the Great Hall. Protecting the Everember. Protecting those who cannot fight. The Otterblade sings.",
      "resolution": "The hall holds. Finn kneels before the Everember, takes the oath. No longer an outsiderâ€”now a defender of Willowmere."
    },

    "storyBeats": [
      {
        "id": "entering_hall",
        "moment": "The doors open onto majesty. Tapestries tell stories of ancient heroes. The Everember's warmth touches Finn's fur.",
        "triggeredBy": "chapter_start",
        "expression": "awe"
      },
      {
        "id": "meeting_friar",
        "moment": "Friar Rowan, keeper of the hearth, approaches. His quills are grey with age, his eyes kind. He knows the blade Finn carries.",
        "triggeredBy": "approach_friar",
        "expression": "hope"
      },
      {
        "id": "the_shattering",
        "moment": "Glass explodes inward. Cold pours through. Frost-wolves in the Great Hall itself. The Everember flickers.",
        "triggeredBy": "attack_begins",
        "expression": "determination"
      },
      {
        "id": "protecting_innocents",
        "moment": "Young ones huddle behind the serving tables. Friar Rowan shields them with his body. Finn must hold the line.",
        "triggeredBy": "civilians_threatened",
        "expression": "determination"
      },
      {
        "id": "everember_threatened",
        "moment": "A Frost Specter approaches the Everember itself. If it reaches the flame, all is lost. Finn leaps to intercept.",
        "triggeredBy": "specter_approach",
        "expression": "fear"
      },
      {
        "id": "the_oath",
        "moment": "The battle won, Finn kneels. Friar Rowan speaks the ancient words. The Everember flares. Finn rises, forever changed.",
        "triggeredBy": "take_oath",
        "expression": "resolve"
      }
    ]
  },

  "connections": {
    "previousChapter": 2,
    "nextChapter": 4,
    
    "transitionIn": {
      "type": "cinematic",
      "cinematicId": "chapter_2_gate_opens",
      "playerSpawnPoint": { "x": 100, "y": 450 }
    },
    
    "transitionOut": {
      "type": "cinematic",
      "cinematicId": "chapter_3_oath_taken",
      "exitPoint": { "x": 2400, "y": 420 }
    },
    
    "unlockRequirements": [
      { "type": "complete_chapter", "value": 2 }
    ]
  },

  "npcs": [
    {
      "id": "friar_rowan",
      "characterId": "friar_rowan",
      "name": "Friar Rowan",
      "role": "mentor",
      "position": { "x": 1200, "y": 430 },
      "facing": "left",
      
      "behavior": {
        "idle": "stand",
        "interactRadius": 80
      },
      
      "storyState": {
        "initialState": "welcoming",
        "states": {
          "welcoming": {
            "animation": "welcome_arms",
            "expression": "warm",
            "canInteract": true
          },
          "explaining": {
            "animation": "gesturing",
            "expression": "wise",
            "canInteract": false
          },
          "protecting": {
            "animation": "shielding",
            "expression": "fierce",
            "canInteract": false
          },
          "blessing": {
            "animation": "blessing",
            "expression": "reverent",
            "canInteract": false
          }
        }
      },
      
      "interactions": [
        {
          "trigger": null,
          "gesture": "welcome_arms",
          "finnResponse": "bow",
          "actions": [
            { "type": "show_toast", "value": "Friar Rowan welcomes you to the heart of Willowmere" },
            { "type": "npc_action", "target": "friar_rowan", "value": "explaining" },
            { "type": "restore_warmth", "value": 20 }
          ]
        }
      ],

      "givesQuest": "quest_great_hall"
    },
    {
      "id": "young_mouse_1",
      "characterId": "npc_mouse_child",
      "name": "Timid Youngster",
      "role": "ambient",
      "position": { "x": 1800, "y": 440 },
      "facing": "left",
      
      "behavior": {
        "idle": "sit",
        "interactRadius": 40
      },
      
      "storyState": {
        "initialState": "curious",
        "states": {
          "curious": { "animation": "looking_up", "expression": "wonder", "canInteract": true },
          "scared": { "animation": "huddled", "expression": "fear", "canInteract": false },
          "safe": { "animation": "relieved", "expression": "relief", "canInteract": true }
        }
      }
    }
  ],

  "quests": [
    {
      "id": "quest_great_hall",
      "name": "Take the Oath",
      "type": "main",
      "giver": "environment",
      
      "objectives": [
        {
          "id": "obj_meet_friar",
          "description": "Meet Friar Rowan at the Everember",
          "type": "interact",
          "target": "friar_rowan"
        },
        {
          "id": "obj_defend_hall",
          "description": "Defend the Great Hall",
          "type": "defeat_enemies",
          "count": 12
        },
        {
          "id": "obj_protect_everember",
          "description": "Protect the Everember from the Frost Specter",
          "type": "defeat_enemies",
          "target": "frost_specter"
        },
        {
          "id": "obj_take_oath",
          "description": "Take the Defender's Oath",
          "type": "interact",
          "target": "everember_shrine"
        }
      ],
      
      "rewards": {
        "emberShards": 100,
        "achievement": "Defender of the Hearth"
      },
      
      "completionTrigger": "chapter_complete"
    }
  ],

  "level": {
    "bounds": {
      "startX": 0,
      "endX": 2500,
      "minY": 0,
      "maxY": 600
    },
    
    "biome": "interior",
    "spawnPoint": { "x": 100, "y": 450 },
    
    "segments": [
      {
        "id": "entrance_corridor",
        "startX": 0,
        "endX": 400,
        
        "platforms": [
          { "x": 0, "y": 480, "width": 400, "type": "abbey_stone", "asset": "platform_hall_floor" }
        ],
        
        "walls": [
          { "x": 0, "y": 0, "width": 30, "height": 480, "asset": "wall_hall_stone" }
        ],
        
        "ceilings": [
          { "x": 0, "y": 50, "width": 400, "height": 30, "asset": "ceiling_vaulted" }
        ]
      },
      {
        "id": "main_hall",
        "startX": 400,
        "endX": 2000,
        
        "platforms": [
          { "x": 400, "y": 480, "width": 1600, "type": "abbey_stone", "asset": "platform_hall_floor" },
          { "x": 600, "y": 380, "width": 100, "type": "wood", "asset": "platform_serving_table" },
          { "x": 900, "y": 380, "width": 150, "type": "wood", "asset": "platform_long_table" },
          { "x": 1400, "y": 380, "width": 150, "type": "wood", "asset": "platform_long_table" },
          { "x": 1700, "y": 380, "width": 100, "type": "wood", "asset": "platform_serving_table" }
        ],
        
        "walls": [
          { "x": 700, "y": 200, "width": 40, "height": 180, "asset": "pillar_stone" },
          { "x": 1100, "y": 200, "width": 40, "height": 180, "asset": "pillar_stone" },
          { "x": 1500, "y": 200, "width": 40, "height": 180, "asset": "pillar_stone" }
        ],
        
        "ceilings": [
          { "x": 400, "y": 50, "width": 1600, "height": 50, "asset": "ceiling_great_hall" }
        ]
      },
      {
        "id": "everember_dais",
        "startX": 2000,
        "endX": 2500,
        
        "platforms": [
          { "x": 2000, "y": 480, "width": 500, "type": "abbey_stone", "asset": "platform_dais" },
          { "x": 2100, "y": 420, "width": 300, "type": "abbey_stone", "asset": "platform_dais_raised" }
        ],
        
        "walls": [
          { "x": 2470, "y": 0, "width": 30, "height": 480, "asset": "wall_hall_back" }
        ],
        
        "ceilings": [
          { "x": 2000, "y": 50, "width": 500, "height": 50, "asset": "ceiling_dome" }
        ]
      }
    ],
    
    "checkpoints": [
      { "id": "checkpoint_entrance", "position": { "x": 200, "y": 450 }, "type": "brazier" },
      { "id": "checkpoint_hall_center", "position": { "x": 1200, "y": 450 }, "type": "brazier", "requiresTrigger": "meet_friar" },
      { "id": "checkpoint_dais", "position": { "x": 2200, "y": 390 }, "type": "brazier", "requiresTrigger": "everember_defended" }
    ]
  },

  "encounters": [
    {
      "id": "wave_1_scout_1",
      "enemyType": "scout",
      "position": { "x": 800, "y": 450 },
      "behavior": { "type": "chase", "aggroRadius": 200 },
      "spawnedByTrigger": "attack_begins",
      "difficulty": "medium"
    },
    {
      "id": "wave_1_scout_2",
      "enemyType": "scout",
      "position": { "x": 1000, "y": 450 },
      "behavior": { "type": "chase", "aggroRadius": 200 },
      "spawnedByTrigger": "attack_begins",
      "difficulty": "medium"
    },
    {
      "id": "wave_1_frostwolf_1",
      "enemyType": "frostwolf",
      "position": { "x": 600, "y": 450 },
      "behavior": { "type": "chase", "aggroRadius": 180 },
      "spawnedByTrigger": "attack_begins",
      "difficulty": "hard"
    },
    {
      "id": "wave_2_frostwolf_1",
      "enemyType": "frostwolf",
      "position": { "x": 1400, "y": 450 },
      "behavior": { "type": "chase", "aggroRadius": 180 },
      "spawnedByTrigger": "wave_2_start",
      "difficulty": "hard"
    },
    {
      "id": "wave_2_frostwolf_2",
      "enemyType": "frostwolf",
      "position": { "x": 1600, "y": 450 },
      "behavior": { "type": "chase", "aggroRadius": 180 },
      "spawnedByTrigger": "wave_2_start",
      "difficulty": "hard"
    },
    {
      "id": "wave_2_icebat_1",
      "enemyType": "icebat",
      "position": { "x": 1200, "y": 200 },
      "behavior": { "type": "patrol", "aggroRadius": 200 },
      "spawnedByTrigger": "wave_2_start",
      "difficulty": "medium"
    },
    {
      "id": "wave_2_icebat_2",
      "enemyType": "icebat",
      "position": { "x": 1500, "y": 180 },
      "behavior": { "type": "patrol", "aggroRadius": 200 },
      "spawnedByTrigger": "wave_2_start",
      "difficulty": "medium"
    },
    {
      "id": "frost_specter",
      "enemyType": "frost_specter",
      "position": { "x": 2000, "y": 300 },
      "behavior": { 
        "type": "goal_driven", 
        "goal": "everember_shrine",
        "aggroRadius": 150,
        "retreatWhenDamaged": false
      },
      "spawnedByTrigger": "specter_spawn",
      "difficulty": "boss",
      "isMiniboss": true
    }
  ],

  "boss": null,

  "interactions": [
    {
      "id": "everember_shrine",
      "type": "shrine",
      "position": { "x": 2250, "y": 350 },
      "asset": "everember_great",
      "activateRadius": 100,
      "initialState": "burning",
      "states": {
        "burning": { 
          "asset": "everember_great_lit", 
          "actions": [{ "type": "restore_warmth", "value": 10 }] 
        },
        "flickering": { 
          "asset": "everember_great_flicker",
          "actions": [{ "type": "drain_warmth", "value": 2 }]
        },
        "blessed": {
          "asset": "everember_great_blessed",
          "actions": [
            { "type": "restore_warmth", "value": 50 },
            { "type": "restore_health", "value": 50 }
          ]
        }
      }
    },
    {
      "id": "window_1",
      "type": "breakable",
      "position": { "x": 800, "y": 150 },
      "asset": "window_stained",
      "hitbox": { "width": 60, "height": 100 },
      "health": 0,
      "triggeredBreak": "attack_begins"
    },
    {
      "id": "window_2",
      "type": "breakable",
      "position": { "x": 1400, "y": 150 },
      "asset": "window_stained",
      "hitbox": { "width": 60, "height": 100 },
      "health": 0,
      "triggeredBreak": "attack_begins"
    }
  ],

  "triggers": [
    {
      "id": "chapter_start",
      "type": "enter_region",
      "region": { "x": 0, "y": 0, "width": 200, "height": 600 },
      "once": true,
      "actions": [
        { "type": "change_music", "target": "music_great_hall_peace" },
        { "type": "show_toast", "value": "The Great Hall" }
      ]
    },
    {
      "id": "approach_friar",
      "type": "enter_region",
      "region": { "x": 1100, "y": 350, "width": 200, "height": 150 },
      "once": true,
      "actions": [
        { "type": "show_toast", "value": "Friar Rowan, Keeper of the Great Hearth" }
      ]
    },
    {
      "id": "meet_friar",
      "type": "interact",
      "targetId": "friar_rowan",
      "once": true,
      "actions": [
        { "type": "unlock_checkpoint" }
      ]
    },
    {
      "id": "attack_begins",
      "type": "timer",
      "delay": 5000,
      "requires": ["meet_friar"],
      "once": true,
      "actions": [
        { "type": "play_sound", "target": "glass_shatter_massive" },
        { "type": "shake_screen", "value": 0.6 },
        { "type": "change_music", "target": "music_great_hall_battle" },
        { "type": "spawn_enemies", "value": ["wave_1_scout_1", "wave_1_scout_2", "wave_1_frostwolf_1"] },
        { "type": "show_toast", "value": "The windows! They're inside!" },
        { "type": "npc_action", "target": "friar_rowan", "value": "protecting" },
        { "type": "npc_action", "target": "young_mouse_1", "value": "scared" }
      ]
    },
    {
      "id": "wave_1_complete",
      "type": "defeat_enemies",
      "once": true,
      "requires": ["attack_begins"],
      "actions": [
        { "type": "show_toast", "value": "More are coming!" }
      ]
    },
    {
      "id": "wave_2_start",
      "type": "defeat_enemies",
      "once": true,
      "requires": ["wave_1_complete"],
      "actions": [
        { "type": "spawn_enemies", "value": ["wave_2_frostwolf_1", "wave_2_frostwolf_2", "wave_2_icebat_1", "wave_2_icebat_2"] },
        { "type": "shake_screen", "value": 0.4 }
      ]
    },
    {
      "id": "civilians_threatened",
      "type": "enter_region",
      "region": { "x": 1700, "y": 380, "width": 150, "height": 100 },
      "requires": ["attack_begins"],
      "once": true,
      "actions": [
        { "type": "show_toast", "value": "Protect the young ones!" }
      ]
    },
    {
      "id": "wave_2_complete",
      "type": "defeat_enemies",
      "once": true,
      "requires": ["wave_2_start"],
      "actions": [
        { "type": "show_toast", "value": "Something cold approaches the Everember..." },
        { "type": "change_music", "target": "music_specter_approach" }
      ]
    },
    {
      "id": "specter_spawn",
      "type": "defeat_enemies",
      "once": true,
      "requires": ["wave_2_complete"],
      "actions": [
        { "type": "spawn_enemies", "value": ["frost_specter"] },
        { "type": "slow_motion", "value": 800 },
        { "type": "camera", "value": { "type": "pan", "target": { "x": 2000, "y": 300 }, "duration": 1500 } }
      ]
    },
    {
      "id": "specter_approach",
      "type": "enter_region",
      "region": { "x": 2100, "y": 250, "width": 100, "height": 200 },
      "once": true,
      "requires": ["specter_spawn"],
      "actions": [
        { "type": "show_toast", "value": "Don't let it reach the Everember!" }
      ]
    },
    {
      "id": "everember_defended",
      "type": "defeat_enemies",
      "once": true,
      "requires": ["specter_spawn"],
      "actions": [
        { "type": "show_toast", "value": "The Everember is safe!" },
        { "type": "change_music", "target": "music_great_hall_peace" },
        { "type": "npc_action", "target": "friar_rowan", "value": "blessing" },
        { "type": "npc_action", "target": "young_mouse_1", "value": "safe" },
        { "type": "unlock_checkpoint" }
      ]
    },
    {
      "id": "take_oath",
      "type": "interact",
      "targetId": "everember_shrine",
      "once": true,
      "requires": ["everember_defended"],
      "actions": [
        { "type": "start_sequence", "target": "oath_ceremony" }
      ]
    },
    {
      "id": "chapter_complete",
      "type": "timer",
      "delay": 5000,
      "requires": ["take_oath"],
      "once": true,
      "actions": [
        { "type": "complete_quest", "target": "quest_great_hall" },
        { "type": "unlock_achievement", "target": "Defender of the Hearth" },
        { "type": "complete_chapter" },
        { "type": "play_cinematic", "target": "chapter_3_oath_taken" }
      ]
    }
  ],

  "sequences": [
    {
      "id": "oath_ceremony",
      "name": "The Defender's Oath",
      "description": "Finn takes the sacred oath before the Everember",
      "playerControl": "none",
      "skippable": false,
      "once": true,
      
      "actions": [
        { "type": "player_control", "value": "none" },
        { "type": "camera", "value": { "type": "zoom", "zoom": 1.3, "duration": 1000 } },
        { "type": "change_music", "target": "music_oath_ceremony" },
        { "type": "actor_animation", "target": "player", "value": "kneel" },
        { "type": "pause", "duration": 1000 },
        { "type": "actor_gesture", "target": "friar_rowan", "value": "blessing", "delay": 500 },
        { "type": "particle_effect", "target": "ember_spiral", "value": { "x": 2250, "y": 350 }, "delay": 1000 },
        { "type": "lighting_change", "target": "everember_flare", "duration": 2000, "delay": 1500 },
        { "type": "restore_warmth", "value": 100, "delay": 2000 },
        { "type": "restore_health", "value": 100, "delay": 2000 },
        { "type": "actor_animation", "target": "player", "value": "rise_determined", "delay": 3000 },
        { "type": "show_toast", "value": "You are now a Defender of Willowmere", "delay": 3500 },
        { "type": "camera", "value": { "type": "zoom", "zoom": 1.0, "duration": 1000 }, "delay": 4000 },
        { "type": "player_control", "value": "full", "delay": 5000 }
      ]
    }
  ],

  "collectibles": [
    { "id": "shard_entrance_1", "type": "ember_shard", "position": { "x": 300, "y": 450 } },
    { "id": "shard_table_1", "type": "ember_shard", "position": { "x": 950, "y": 350 } },
    { "id": "shard_table_2", "type": "ember_shard", "position": { "x": 1450, "y": 350 } },
    { "id": "shard_pillar_1", "type": "ember_shard", "position": { "x": 720, "y": 200 }, "hidden": true },
    { "id": "hearthstone_hall", "type": "hearthstone", "position": { "x": 2300, "y": 390 }, "requiresTrigger": "everember_defended" },
    { "id": "lore_everember", "type": "lore_fragment", "position": { "x": 2150, "y": 450 } }
  ],

  "secrets": [
    {
      "id": "secret_abbots_alcove",
      "name": "The Abbot's Alcove",
      "type": "hidden_room",
      "entrance": { "x": 2450, "y": 300, "width": 30, "height": 80 },
      "hint": "Behind the great tapestry, a hidden alcove where abbots once meditated",
      "rewards": {
        "emberShards": 25,
        "hearthstones": 1,
        "loreFragment": "lore_first_defender",
        "achievement": "Keeper of Secrets"
      }
    }
  ],

  "media": {
    "chapterPlate": "great_hall_oath_chapter_plate",
    "parallaxBackground": "abbey_interior_parallax_background",
    "introCinematic": "chapter_2_gate_opens",
    "outroCinematic": "chapter_3_oath_taken",
    "bossIntroCinematic": null,
    
    "musicTracks": {
      "exploration": "music_great_hall_peace",
      "tension": "music_specter_approach",
      "combat": "music_great_hall_battle",
      "boss": "music_specter_approach",
      "victory": "music_oath_ceremony"
    },
    
    "ambientSounds": [
      "ambient_hearth_crackle",
      "ambient_hall_echo",
      "ambient_distant_chanting"
    ]
  },

  "environment": {
    "lighting": {
      "ambientColor": "#F4A460",
      "ambientIntensity": 0.7,
      "warmthInfluence": true
    },
    
    "weather": {
      "type": "none",
      "intensity": 0,
      "affectsGameplay": false
    },
    
    "warmthDrain": 0,
    
    "particles": [
      {
        "type": "embers",
        "density": 0.4,
        "region": { "x": 2100, "y": 300, "width": 300, "height": 200 }
      },
      {
        "type": "dust",
        "density": 0.2,
        "region": { "x": 400, "y": 50, "width": 1600, "height": 200 }
      }
    ]
  }
}
