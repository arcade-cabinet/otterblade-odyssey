# Claude Initial PR Review
# Fast initial review using Haiku 4.5 for cost efficiency
# Pin: anthropics/claude-code-action@b17b541bbc4d94ffa42edf2e2384ffe702e59370

name: Claude Initial PR Review

on:
  pull_request:
    types: [opened]

# No workflow-level permissions - job level only
permissions: {}

jobs:
  review:
    name: Initial PR Review
    # Skip if PR is in draft mode
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    timeout-minutes: 20
    concurrency:
      group: claude-review-${{ github.event.pull_request.number }}
      cancel-in-progress: true
    permissions:
      contents: read
      pull-requests: write
      id-token: write
      actions: read
    
    steps:
      - name: Check API Key
        id: check-key
        run: |
          if [ -n "${{ secrets.ANTHROPIC_API_KEY }}" ]; then
            echo "available=true" >> $GITHUB_OUTPUT
          else
            echo "::warning::ANTHROPIC_API_KEY not configured"
            echo "available=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout
        if: steps.check-key.outputs.available == 'true'
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0
          token: ${{ secrets.CI_GITHUB_TOKEN }}
          persist-credentials: false

      - name: Sanitize Inputs
        if: steps.check-key.outputs.available == 'true'
        id: sanitize
        run: |
          # Sanitize PR title: remove quotes, backticks, dollar signs, exclamation marks, limit to 100 chars
          SAFE_TITLE=$(echo "${{ github.event.pull_request.title }}" | tr -d '"' | tr -d "'" | tr -d '`' | tr -d '$' | tr -d '!' | cut -c1-100)
          echo "pr_title=$SAFE_TITLE" >> $GITHUB_OUTPUT
          
          # Sanitize author: alphanumeric + underscore/dash only
          SAFE_AUTHOR=$(echo "${{ github.event.pull_request.user.login }}" | tr -cd 'a-zA-Z0-9_-')
          echo "pr_author=$SAFE_AUTHOR" >> $GITHUB_OUTPUT

      - name: Run Initial Review
        if: steps.check-key.outputs.available == 'true'
        uses: anthropics/claude-code-action@b17b541bbc4d94ffa42edf2e2384ffe702e59370
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_TITLE: ${{ steps.sanitize.outputs.pr_title }}
          PR_AUTHOR: ${{ steps.sanitize.outputs.pr_author }}
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.CI_GITHUB_TOKEN }}
          include_fix_links: true
          allowed_bots: "cursor[bot],jules[bot],google-labs-jules[bot],copilot-swe-agent[bot],dependabot[bot],renovate[bot],github-actions[bot],coderabbitai[bot]"
          
          prompt: |
            # Initial PR Review
            
            You are performing an initial comprehensive review of PR #${{ env.PR_NUMBER }}.
            
            **PR Details:**
            - **Title**: ${{ env.PR_TITLE }}
            - **Author**: @${{ env.PR_AUTHOR }}
            - **Repository**: ${{ github.repository }}
            
            ## Review Focus Areas
            
            Perform a thorough review focusing on:
            
            ### 1. Code Quality & Best Practices
            - **Readability**: Is the code clear and well-structured?
            - **Maintainability**: Will this be easy to update in the future?
            - **Consistency**: Does it follow existing code patterns?
            - **Documentation**: Are complex parts explained?
            - **Error Handling**: Are edge cases and errors handled properly?
            
            ### 2. Security Vulnerabilities
            - **Input Validation**: Are user inputs sanitized?
            - **SQL Injection**: Any raw SQL queries with unsanitized input?
            - **XSS**: Any unescaped user content in HTML?
            - **Authentication**: Are auth checks in place?
            - **Secrets**: Any hardcoded credentials or API keys?
            - **Dependencies**: Are new dependencies from trusted sources?
            
            ### 3. Performance Implications
            - **Algorithms**: Are they efficient for expected data sizes?
            - **Database Queries**: N+1 queries? Missing indexes?
            - **Memory Usage**: Any memory leaks or excessive allocations?
            - **Network Calls**: Are they batched/cached appropriately?
            - **Build Size**: Will this significantly increase bundle size?
            
            ### 4. Test Coverage
            - **Unit Tests**: Are new functions tested?
            - **Integration Tests**: Are new features covered?
            - **Edge Cases**: Are boundary conditions tested?
            - **Regression Tests**: Could this break existing functionality?
            
            ### 5. Documentation Completeness
            - **README**: Does it need updates?
            - **API Docs**: Are new APIs documented?
            - **Comments**: Are non-obvious parts explained?
            - **Changelog**: Should this be noted?
            
            ## Review Format
            
            Use **inline comments** for specific issues with line-by-line feedback.
            Use a **top-level PR comment** for the overall summary.
            
            ### Inline Comment Format:
            ```
            **[Category]**: Issue title
            
            Description of the issue and why it matters.
            
            **Recommendation**:
            Specific actionable fix.
            
            **Priority**: Critical / High / Medium / Low
            ```
            
            ### Summary Comment Format:
            ```markdown
            ## Initial Review Summary
            
            ### Overview
            <1-2 sentence summary of the PR>
            
            ### Strengths âœ…
            - <positive aspects>
            
            ### Issues Found
            
            #### ðŸ”´ Critical (Must Fix)
            - <critical issues>
            
            #### ðŸŸ¡ High Priority (Should Fix)
            - <high priority issues>
            
            #### ðŸŸ¢ Medium Priority (Consider)
            - <medium priority issues>
            
            #### âšª Low Priority (Optional)
            - <low priority suggestions>
            
            ### Test Coverage Assessment
            <assessment of test coverage>
            
            ### Overall Recommendation
            <Approve / Request Changes / Comment>
            ```
            
            ## Guidelines
            
            - **Be constructive**: Frame feedback positively
            - **Be specific**: Reference exact files and lines
            - **Be actionable**: Provide clear recommendations
            - **Be realistic**: Consider time/effort tradeoffs
            - **Be fair**: Acknowledge good work too
            
            ## Getting Started
            
            1. Review the PR diff using `gh pr diff ${{ env.PR_NUMBER }}`
            2. Check files changed using `gh pr view ${{ env.PR_NUMBER }} --json files`
            3. Review existing codebase patterns for context
            4. Post inline comments for specific issues
            5. Post summary comment with overall assessment
            
            **Start your review now.**

          claude_args: |
            --model claude-haiku-4-5-20251001
            --allowedTools "mcp__github_inline_comment__create_inline_comment,Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Read,GlobTool,GrepTool"
