# Triage - Unified Issue & PR Triage Pipeline
# Consolidates: ai-curator.yml, ecosystem-triage.yml, jules-pr-auto-triage.yml
#
# Responsibilities:
# - New issue triage and labeling
# - PR tracking issue management
# - Daily deduplication
# - Scheduled maintenance

name: Triage

on:
  # Issue events
  issues:
    types: [opened, labeled]

  # PR events
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review, closed, labeled]
  pull_request_review:
    types: [submitted, dismissed]

  # Comment events
  issue_comment:
    types: [created]

  # Scheduled tasks
  schedule:
    - cron: '0 3 * * *'  # 3 AM UTC daily

  # Manual trigger
  workflow_dispatch:
    inputs:
      mode:
        description: 'Triage mode'
        type: choice
        options:
          - full
          - triage-only
          - dedup-only
        default: full

env:
  # AI agent patterns for PR tracking (pipe-separated regex)
  # Configure via repository variables: AI_AGENT_PATTERNS
  AI_AGENT_PATTERNS: ${{ vars.AI_AGENT_PATTERNS || 'copilot|github-actions|coderabbitai|gemini|cursor|amazon-q|dependabot|bugbot|claude|sonarcloud|codacy|snyk' }}

permissions: {}

jobs:
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # NEW ISSUE TRIAGE (Claude)
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  issue-triage:
    name: Issue Triage
    if: github.event_name == 'issues' && github.event.action == 'opened'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    concurrency:
      group: issue-triage-${{ github.event.issue.number }}
      cancel-in-progress: true
    permissions:
      contents: read
      issues: write
      id-token: write
    steps:
      - name: Check API Key
        id: check-key
        run: |
          if [ -n "${{ secrets.ANTHROPIC_API_KEY }}" ]; then
            echo "available=true" >> $GITHUB_OUTPUT
          else
            echo "::warning::ANTHROPIC_API_KEY not configured"
            echo "available=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout
        if: steps.check-key.outputs.available == 'true'
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 1
          # Use workflow-scoped token for checkout (more restrictive than CI_GITHUB_TOKEN)
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Triage with Claude
        if: steps.check-key.outputs.available == 'true'
        uses: anthropics/claude-code-action@7145c3e0510bcdbdd29f67cc4a8c1958f1acfa2f # v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.CI_GITHUB_TOKEN }}
          allowed_bots: "cursor[bot],jules[bot],google-labs-jules[bot],copilot-swe-agent[bot],dependabot[bot],renovate[bot],github-actions[bot]"
          prompt: |
            Triage issue #${{ github.event.issue.number }} in ${{ github.repository }}.

            1. Add appropriate labels (bug/enhancement/docs, priority)
            2. Check for duplicates - link and close if duplicate
            3. Add a helpful acknowledgment comment
          claude_args: |
            --allowedTools "Read,Glob,Grep,LS,Bash(gh:*),mcp__github__get_issue,mcp__github__update_issue,mcp__github__add_issue_comment,mcp__github__list_issues,mcp__github__search_issues"

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # PR TRACKING ISSUE MANAGEMENT (Ecosystem Triage)
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  pr-tracking:
    name: PR Tracking
    if: |
      github.event_name == 'pull_request' ||
      github.event_name == 'pull_request_review' ||
      (github.event_name == 'issue_comment' &&
       contains(github.event.comment.body, '@cascade synthesize'))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
    concurrency:
      group: pr-tracking-${{ github.event.pull_request.number || github.event.issue.number }}
      cancel-in-progress: true
    outputs:
      tracking_issue: ${{ steps.triage.outputs.tracking_issue }}
      verdict: ${{ steps.triage.outputs.verdict }}
      pr_number: ${{ steps.triage.outputs.pr_number }}
    steps:
      - name: Manage PR Tracking Issue
        id: triage
        env:
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
        run: |
          # Resolve PR context
          case "${{ github.event_name }}" in
            issue_comment)
              if [ -z "${{ github.event.issue.pull_request }}" ]; then
                echo "Comment not on a PR, skipping"
                exit 0
              fi
              PR_NUM="${{ github.event.issue.number }}"
              ;;
            *)
              PR_NUM="${{ github.event.pull_request.number }}"
              ;;
          esac

          [ -z "$PR_NUM" ] && echo "No PR number" && exit 0
          echo "pr_number=$PR_NUM" >> $GITHUB_OUTPUT

          # Handle PR closed event
          if [ "${{ github.event.action }}" = "closed" ]; then
            echo "üèÅ PR #$PR_NUM closed - closing tracking issue..."
            TRACKING=$(gh issue list --repo "${{ github.repository }}" --label "synthesis" --search "synthesis-pr-$PR_NUM in:title" --json number --jq '.[0].number // empty')
            if [ -n "$TRACKING" ]; then
              if [ "${{ github.event.pull_request.merged }}" = "true" ]; then
                gh issue close $TRACKING --repo "${{ github.repository }}" --comment "‚úÖ PR #$PR_NUM merged successfully." 2>/dev/null || true
              else
                gh issue close $TRACKING --repo "${{ github.repository }}" --comment "‚ùå PR #$PR_NUM closed without merge." 2>/dev/null || true
              fi
            fi
            exit 0
          fi

          # Get PR details
          PR_DATA=$(gh pr view $PR_NUM --repo "${{ github.repository }}" --json title,url,author,headRefName,isDraft 2>/dev/null || echo "{}")
          PR_TITLE=$(echo "$PR_DATA" | jq -r '.title // "Unknown"')
          PR_URL=$(echo "$PR_DATA" | jq -r '.url // ""')
          PR_AUTHOR=$(echo "$PR_DATA" | jq -r '.author.login // "unknown"')
          PR_BRANCH=$(echo "$PR_DATA" | jq -r '.headRefName // "unknown"')
          IS_DRAFT=$(echo "$PR_DATA" | jq -r '.isDraft // false')

          # Skip drafts
          [ "$IS_DRAFT" = "true" ] && echo "Draft PR, skipping" && exit 0

          OWNER="${{ github.repository_owner }}"
          REPO="${{ github.event.repository.name }}"
          AI_AGENTS="${{ env.AI_AGENT_PATTERNS }}"

          # Get or create tracking issue
          ISSUE_KEY="synthesis-pr-$PR_NUM"

          # Ensure labels exist
          for LABEL in "synthesis:7057FF" "queue-blocked:B60205" "queue-review:FBCA04" "queue-ready:0E8A16"; do
            NAME="${LABEL%%:*}"
            COLOR="${LABEL##*:}"
            gh label create "$NAME" --color "$COLOR" --repo "${{ github.repository }}" 2>/dev/null || true
          done

          # Search for existing tracking issue
          TRACKING_ISSUE=$(gh issue list --repo "${{ github.repository }}" --label "synthesis" --search "$ISSUE_KEY in:title" --json number --jq '.[0].number // empty' 2>/dev/null)

          if [ -z "$TRACKING_ISSUE" ]; then
            TRACKING_ISSUE=$(gh issue create --repo "${{ github.repository }}" \
              --title "$ISSUE_KEY: $PR_TITLE" \
              --body "# üî¨ Synthesis: PR #$PR_NUM

          > **PR:** $PR_URL
          > **Author:** @$PR_AUTHOR
          > **Branch:** \`$PR_BRANCH\`

          ---

          ## üìä Queue State

          | Metric | Value |
          |--------|-------|
          | Status | Initializing... |

          ---
          <sub>ü§ñ Managed by Triage</sub>" \
              --label "synthesis" \
              2>/dev/null | grep -oE '[0-9]+$')

            gh pr comment $PR_NUM --repo "${{ github.repository }}" --body "üì¶ **Tracking:** #$TRACKING_ISSUE" 2>/dev/null || true
          fi

          echo "tracking_issue=$TRACKING_ISSUE" >> $GITHUB_OUTPUT

          # Gather AI feedback
          QUERY='query($owner: String!, $repo: String!, $pr: Int!) {
            repository(owner: $owner, name: $repo) {
              pullRequest(number: $pr) {
                reviews(first: 100) { nodes { author { login } body state } }
                reviewThreads(first: 100) {
                  nodes {
                    id isResolved isOutdated path line
                    comments(first: 3) { nodes { author { login } body } }
                  }
                }
              }
            }
          }'

          RESULT=$(gh api graphql -f query="$QUERY" -f owner="$OWNER" -f repo="$REPO" -F pr="$PR_NUM" 2>/dev/null || echo "{}")

          # Count feedback
          REVIEW_COUNT=$(echo "$RESULT" | jq --arg a "$AI_AGENTS" '[.data.repository.pullRequest.reviews.nodes[]? | select(.author.login | test($a; "i"))] | length' 2>/dev/null || echo "0")
          THREAD_COUNT=$(echo "$RESULT" | jq --arg a "$AI_AGENTS" '[.data.repository.pullRequest.reviewThreads.nodes[]? | select(.isResolved == false) | select(.comments.nodes[0].author.login | test($a; "i"))] | length' 2>/dev/null || echo "0")
          CRITICAL_COUNT=$(echo "$RESULT" | jq --arg a "$AI_AGENTS" '[.data.repository.pullRequest.reviewThreads.nodes[]? | select(.isResolved == false) | select(.comments.nodes[0].author.login | test($a; "i")) | select(.comments.nodes[0].body | test("security|vulnerability|critical|breaking"; "i"))] | length' 2>/dev/null || echo "0")

          # Resolve outdated threads
          OUTDATED_IDS=$(echo "$RESULT" | jq -r --arg a "$AI_AGENTS" '
            .data.repository.pullRequest.reviewThreads.nodes[]? |
            select(.isOutdated == true and .isResolved == false) |
            select(.comments.nodes[0].author.login | test($a; "i")) | .id
          ' 2>/dev/null || echo "")

          RESOLVED=0
          for TID in $OUTDATED_IDS; do
            [ -z "$TID" ] && continue
            gh api graphql -f query='mutation($id: ID!) { resolveReviewThread(input: {threadId: $id}) { thread { isResolved } } }' -f id="$TID" 2>/dev/null && RESOLVED=$((RESOLVED + 1))
          done

          # Determine verdict
          if [ "$CRITICAL_COUNT" -gt 0 ]; then
            VERDICT="BLOCKED"; VERDICT_EMOJI="üî¥"; VERDICT_LABEL="queue-blocked"
          elif [ "$THREAD_COUNT" -gt 0 ]; then
            VERDICT="REVIEW"; VERDICT_EMOJI="üü°"; VERDICT_LABEL="queue-review"
          else
            VERDICT="READY"; VERDICT_EMOJI="‚úÖ"; VERDICT_LABEL="queue-ready"
          fi

          echo "verdict=$VERDICT" >> $GITHUB_OUTPUT

          # Build feedback list
          FEEDBACK=""
          if [ "$THREAD_COUNT" -gt 0 ]; then
            FEEDBACK=$(echo "$RESULT" | jq -r --arg a "$AI_AGENTS" '
              [.data.repository.pullRequest.reviewThreads.nodes[]? |
               select(.isResolved == false) |
               select(.comments.nodes[0].author.login | test($a; "i"))] |
              .[:10][] |
              "- [ ] **\(.comments.nodes[0].author.login)** on `\(.path):\(.line // "?")`"
            ' 2>/dev/null || echo "")
          fi
          [ -z "$FEEDBACK" ] && FEEDBACK="_No active feedback._"

          # Update tracking issue
          BODY="# üî¨ Synthesis: PR #$PR_NUM

          > **PR:** $PR_URL
          > **Author:** @$PR_AUTHOR
          > **Branch:** \`$PR_BRANCH\`

          ---

          ## üìä Queue State

          | Metric | Value |
          |--------|-------|
          | Reviews | $REVIEW_COUNT |
          | Active Threads | $THREAD_COUNT |
          | Critical | $CRITICAL_COUNT |
          | Resolved | $RESOLVED |
          | Updated | $(date -u +%Y-%m-%dT%H:%M:%SZ) |

          ## üéØ Verdict: $VERDICT_EMOJI $VERDICT

          ## üìù Feedback Queue

          $FEEDBACK

          ---

          **Commands:** \`@cascade address\` ¬∑ \`@cascade synthesize\` ¬∑ \`@cascade merge\`

          <sub>ü§ñ Triage</sub>"

          gh issue edit $TRACKING_ISSUE --repo "${{ github.repository }}" --body "$BODY" 2>/dev/null || true
          gh issue edit $TRACKING_ISSUE --repo "${{ github.repository }}" --remove-label "queue-blocked,queue-review,queue-ready" 2>/dev/null || true
          gh issue edit $TRACKING_ISSUE --repo "${{ github.repository }}" --add-label "$VERDICT_LABEL" 2>/dev/null || true

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # SCHEDULED: ISSUE DEDUPLICATION (Claude)
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  deduplication:
    name: Issue Deduplication
    if: |
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_dispatch' && inputs.mode != 'triage-only')
    runs-on: ubuntu-latest
    timeout-minutes: 10
    concurrency:
      group: deduplication
      cancel-in-progress: true
    permissions:
      contents: read
      issues: write
      id-token: write
    steps:
      - name: Check API Key
        id: check-key
        run: |
          if [ -n "${{ secrets.ANTHROPIC_API_KEY }}" ]; then
            echo "available=true" >> $GITHUB_OUTPUT
          else
            echo "available=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout
        if: steps.check-key.outputs.available == 'true'
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 1
          # Use workflow-scoped token for checkout (more restrictive than CI_GITHUB_TOKEN)
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Dedup with Claude
        if: steps.check-key.outputs.available == 'true'
        uses: anthropics/claude-code-action@7145c3e0510bcdbdd29f67cc4a8c1958f1acfa2f # v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.CI_GITHUB_TOKEN }}
          allowed_bots: "cursor[bot],jules[bot],google-labs-jules[bot],copilot-swe-agent[bot],dependabot[bot],renovate[bot],github-actions[bot]"
          prompt: |
            Scan ${{ github.repository }} for duplicate issues.

            Find similar issues, link duplicates to the canonical issue, and close them.
          claude_args: |
            --allowedTools "Read,Glob,Grep,LS,Bash(gh:*),mcp__github__list_issues,mcp__github__search_issues,mcp__github__get_issue,mcp__github__update_issue,mcp__github__add_issue_comment"
