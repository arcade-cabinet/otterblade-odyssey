name: Jules Bug Fixer

on:
  issues:
    types: [labeled]

# No workflow-level permissions - all permissions defined at job level
permissions: {}

jobs:
  fix-bug:
    # Only run when the 'bug' label is added
    if: github.event.label.name == 'bug'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      issues: read
      id-token: write
    steps:
      - name: Invoke Jules
        uses: google-labs-code/jules-action@bff7875eaa123cac6742b7cfc51005b95ba4d566 # v1.0.0
        with:
          prompt: |
            # üêõ BUG FIX TASK - PULL REQUEST REQUIRED

            ## ‚ö†Ô∏è CRITICAL REQUIREMENT
            **YOU MUST CREATE A PULL REQUEST.** This is not optional.
            - If you cannot fix the bug, create a PR with diagnostic information
            - If you need more info, create a PR with what you found and questions
            - NEVER exit without creating a PR

            ---

            You are fixing a bug in **Otterblade Odyssey: Zephyros Rising**, a React 2.5D platformer game.

            ## Project Context
            - **Tech Stack:** React Three Fiber, Rapier2D physics, Miniplex ECS, Zustand, Tailwind CSS v4
            - **Package Manager:** pnpm ONLY (never npm/yarn)
            - **TypeScript Target:** ES2022 (required for Miniplex)
            - **Node.js:** 25.x

            ## Bug Report

            **Issue:** #${{ github.event.issue.number }}
            **Title:** ${{ github.event.issue.title }}

            ${{ github.event.issue.body }}

            ## Debugging Process

            1. **Analysis** - Review the bug report and understand the symptoms
            2. **Diagnosis** - Trace the issue through the codebase
               - Check ECS entities in `client/src/game/ecs/`
               - Check physics in `client/src/game/Physics2D.tsx`
               - Check state in `client/src/game/store.ts`
            3. **Fix** - Implement a minimal, targeted fix
            4. **Testing** - Add a regression test if possible
            5. **Verification** - Run `pnpm biome check .` and `pnpm tsc --noEmit`

            ## MANDATORY PULL REQUEST FORMAT

            **Branch Name:** `jules/fix-issue-${{ github.event.issue.number }}`

            **PR Title:** `üêõ Fix: [Brief description of fix]`

            **PR Body MUST include:**
            ```markdown
            ## Summary
            Fixes #${{ github.event.issue.number }}

            ## Root Cause
            [Explain what caused the bug]

            ## Solution
            [Explain the fix]

            ## Testing
            - [ ] Ran `pnpm biome check .`
            - [ ] Ran `pnpm tsc --noEmit`
            - [ ] Manual testing performed

            ## Labels
            - `jules-pr`
            - `bug-fix`
            - `auto-triage`
            ```

            **PR Labels:** `jules-pr`, `bug-fix`, `auto-triage`

            ## Code Quality Rules
            - Follow patterns in AGENTS.md
            - Max 200 lines per component
            - JSDoc on all exports
            - No console.log in production code
          jules_api_key: ${{ secrets.GOOGLE_JULES_API_KEY }}
          starting_branch: 'main'
