# Release Gate - E2E tests run before merge to main
# Requires 'release' environment approval
name: Release Gate

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, ready_for_review]

permissions:
  contents: read
  pull-requests: write
  actions: read

concurrency:
  group: release-gate-${{ github.event.pull_request.number }}
  cancel-in-progress: false

env:
  NODE_VERSION: 25
  PNPM_VERSION: 10

jobs:
  # Wait for CI to pass first
  wait-for-ci:
    name: Wait for CI
    runs-on: ubuntu-latest
    steps:
      - name: Wait for CI workflow
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Waiting for CI workflow to complete..."
          for i in {1..60}; do
            STATUS=$(gh run list --workflow=ci.yml --branch="${{ github.head_ref }}" --limit=1 --json conclusion --jq '.[0].conclusion // "pending"' --repo "${{ github.repository }}" 2>/dev/null || echo "pending")
            if [ "$STATUS" = "success" ]; then
              echo "✅ CI passed"
              exit 0
            elif [ "$STATUS" = "failure" ] || [ "$STATUS" = "cancelled" ]; then
              echo "❌ CI failed or cancelled"
              exit 1
            fi
            echo "CI status: $STATUS - waiting..."
            sleep 10
          done
          echo "⏱️ Timeout waiting for CI"
          exit 1

  # E2E Tests - the release gate
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: wait-for-ci
    environment: release
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - uses: pnpm/action-setup@9fd676a19091d4595eefd76e4bd31c97133911f1 # v4.2.0

      - uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Download build
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: build-dist
          path: dist/
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
        continue-on-error: true

      - name: Build if no artifact
        run: |
          if [ ! -d "dist" ]; then
            pnpm build
          fi

      - name: Get Playwright version
        id: pw-version
        run: echo "version=$(pnpm list @playwright/test --json | jq -r '.[0].dependencies["@playwright/test"].version // .[0].devDependencies["@playwright/test"].version')" >> $GITHUB_OUTPUT

      - name: Cache Playwright
        id: pw-cache
        uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ steps.pw-version.outputs.version }}

      - name: Install Playwright
        if: steps.pw-cache.outputs.cache-hit != 'true'
        run: pnpm exec playwright install --with-deps chromium

      - name: Install Playwright deps
        if: steps.pw-cache.outputs.cache-hit == 'true'
        run: pnpm exec playwright install-deps chromium

      - name: Run E2E tests
        id: e2e
        run: pnpm test:e2e

      - name: Upload report
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: ${{ !cancelled() }}
        with:
          name: playwright-report
          path: |
            playwright-report/
            test-results/
          retention-days: 30

  # AI Triage on failure
  ai-triage:
    name: AI Triage
    runs-on: ubuntu-latest
    needs: e2e-tests
    if: failure()
    permissions:
      contents: write
      pull-requests: write
      issues: write
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          token: ${{ secrets.CI_GITHUB_TOKEN }}

      - name: Triage failure
        env:
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
          PR_NUM: ${{ github.event.pull_request.number }}
        run: |
          gh pr comment "$PR_NUM" --body "## ❌ Release Gate Failed

          E2E tests failed. AI fixer will attempt to resolve this.

          **Workflow run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          If the fix fails, this PR will need manual intervention."

      # Trigger AI fixer
      - name: Trigger AI Fixer
        env:
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
        run: |
          gh workflow run ai-fixer.yml \
            --ref "${{ github.head_ref }}" \
            --repo "${{ github.repository }}" \
            -f run_id="${{ github.run_id }}" \
            -f repository="${{ github.repository }}" \
            -f branch="${{ github.head_ref }}" || true
