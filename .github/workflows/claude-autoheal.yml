# Claude Auto-Heal - Continuous Healing on AI Feedback
# Triggers automatically when AI agents post feedback
# Pin: anthropics/claude-code-action@b17b541bbc4d94ffa42edf2e2384ffe702e59370

name: Claude Auto-Heal

on:
  issue_comment:
    types: [created]
  pull_request_review:
    types: [submitted]
  check_run:
    types: [completed]
  workflow_run:
    types: [completed]

# No workflow-level permissions - job level only
permissions: {}

jobs:
  # ════════════════════════════════════════════════════════════════
  # DETECT: Check if this is AI agent feedback
  # ════════════════════════════════════════════════════════════════
  detect-ai-feedback:
    name: Detect AI Feedback
    # Only run for PR-related events, skip if triggered by bot to prevent loops
    if: |
      github.actor != 'github-actions[bot]' &&
      github.actor != 'claude[bot]' &&
      (
        (github.event_name == 'issue_comment' && github.event.issue.pull_request) ||
        github.event_name == 'pull_request_review' ||
        (github.event_name == 'check_run' && github.event.check_run.conclusion == 'failure' && github.event.check_run.pull_requests[0]) ||
        (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'failure' && github.event.workflow_run.pull_requests[0])
      )
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      pull-requests: read
      checks: read
      actions: read
    outputs:
      has_ai_feedback: ${{ steps.detect.outputs.has_ai_feedback }}
      ai_agents: ${{ steps.detect.outputs.agents }}
      pr_number: ${{ steps.detect.outputs.pr_number }}
      pr_branch: ${{ steps.detect.outputs.pr_branch }}
      feedback_type: ${{ steps.detect.outputs.feedback_type }}
    
    steps:
      - name: Detect AI Agent Feedback
        id: detect
        env:
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
          EVENT_NAME: ${{ github.event_name }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          COMMENT_USER: ${{ github.event.comment.user.login }}
          REVIEW_USER: ${{ github.event.review.user.login }}
          CHECK_APP: ${{ github.event.check_run.app.slug }}
          WORKFLOW_NAME: ${{ github.event.workflow_run.name }}
        run: |
          # Sanitize user inputs to prevent command injection
          # Only allow alphanumeric, underscore, dash, and brackets (for bot names)
          SAFE_COMMENT_USER=$(echo "$COMMENT_USER" | tr -cd 'a-zA-Z0-9_-[]')
          SAFE_REVIEW_USER=$(echo "$REVIEW_USER" | tr -cd 'a-zA-Z0-9_-[]')
          
          AGENTS=""
          FEEDBACK_TYPE=""
          PR_NUM=""
          PR_BRANCH=""
          
          # Detect based on event type
          if [ "$EVENT_NAME" = "issue_comment" ]; then
            PR_NUM="${{ github.event.issue.number }}"
            
            # Detect AI agents by username (more precise than content matching)
            if [[ "$SAFE_COMMENT_USER" == *"coderabbit"* ]] || [[ "$SAFE_COMMENT_USER" == "coderabbitai"* ]]; then
              AGENTS="${AGENTS}coderabbit,"
              FEEDBACK_TYPE="code_review"
            elif [[ "$SAFE_COMMENT_USER" == *"gemini"* ]]; then
              AGENTS="${AGENTS}gemini,"
              FEEDBACK_TYPE="code_review"
            elif [[ "$SAFE_COMMENT_USER" == *"copilot"* ]]; then
              AGENTS="${AGENTS}copilot,"
              FEEDBACK_TYPE="code_review"
            elif [[ "$SAFE_COMMENT_USER" == "github-code-scanning"* ]] || [[ "$SAFE_COMMENT_USER" == "github-advanced-security"* ]]; then
              AGENTS="${AGENTS}codeql,"
              FEEDBACK_TYPE="security_alert"
            fi
            
          elif [ "$EVENT_NAME" = "pull_request_review" ]; then
            PR_NUM="${{ github.event.pull_request.number }}"
            
            # Detect AI reviewer
            if [[ "$SAFE_REVIEW_USER" == *"coderabbit"* ]] || [[ "$SAFE_REVIEW_USER" == "coderabbitai"* ]]; then
              AGENTS="${AGENTS}coderabbit,"
              FEEDBACK_TYPE="code_review"
            fi
            if [[ "$SAFE_REVIEW_USER" == *"copilot"* ]]; then
              AGENTS="${AGENTS}copilot,"
              FEEDBACK_TYPE="code_review"
            fi
            
          elif [ "$EVENT_NAME" = "check_run" ]; then
            PR_NUM="${{ github.event.check_run.pull_requests[0].number }}"
            
            # Detect by check app
            if [[ "$CHECK_APP" == *"codeql"* ]]; then
              AGENTS="${AGENTS}codeql,"
              FEEDBACK_TYPE="security_alert"
            fi
            
          elif [ "$EVENT_NAME" = "workflow_run" ]; then
            PR_NUM="${{ github.event.workflow_run.pull_requests[0].number }}"
            
            # CI/CD failures are feedback
            AGENTS="ci_failure,"
            FEEDBACK_TYPE="ci_failure"
          fi
          
          # Get PR branch if we have PR number
          if [ -n "$PR_NUM" ]; then
            PR_BRANCH=$(gh pr view "$PR_NUM" --json headRefName --jq '.headRefName' 2>/dev/null || echo "")
          fi
          
          # Determine if we have actionable AI feedback
          if [ -n "$AGENTS" ]; then
            echo "has_ai_feedback=true" >> $GITHUB_OUTPUT
            echo "agents=${AGENTS%,}" >> $GITHUB_OUTPUT
            echo "pr_number=$PR_NUM" >> $GITHUB_OUTPUT
            echo "pr_branch=$PR_BRANCH" >> $GITHUB_OUTPUT
            echo "feedback_type=$FEEDBACK_TYPE" >> $GITHUB_OUTPUT
            echo "✅ Detected AI feedback: $AGENTS"
          else
            echo "has_ai_feedback=false" >> $GITHUB_OUTPUT
            echo "❌ No AI feedback detected"
          fi

  # ════════════════════════════════════════════════════════════════
  # AUTO-HEAL: Respond to AI feedback
  # ════════════════════════════════════════════════════════════════
  auto-heal:
    name: Auto-Heal
    needs: detect-ai-feedback
    if: needs.detect-ai-feedback.outputs.has_ai_feedback == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 45
    concurrency:
      group: claude-autoheal-${{ needs.detect-ai-feedback.outputs.pr_number }}
      cancel-in-progress: false
    permissions:
      contents: write
      pull-requests: write
      actions: read
      checks: read
      id-token: write
    
    steps:
      - name: Check API Key
        id: check-key
        run: |
          if [ -n "${{ secrets.ANTHROPIC_API_KEY }}" ]; then
            echo "available=true" >> $GITHUB_OUTPUT
          else
            echo "::warning::ANTHROPIC_API_KEY not configured"
            echo "available=false" >> $GITHUB_OUTPUT
          fi

      - name: Determine PR Strategy
        if: steps.check-key.outputs.available == 'true'
        id: strategy
        env:
          PR_BRANCH: ${{ needs.detect-ai-feedback.outputs.pr_branch }}
        run: |
          # Validate branch name format
          if [[ ! "$PR_BRANCH" =~ ^[a-zA-Z0-9/_-]+$ ]]; then
            echo "::error::Invalid branch name format: $PR_BRANCH"
            exit 1
          fi
          
          # Use regex matching for security
          if [[ "$PR_BRANCH" =~ ^copilot/ ]]; then
            echo "mode=collaborative" >> $GITHUB_OUTPUT
            echo "agent=@copilot" >> $GITHUB_OUTPUT
          elif [[ "$PR_BRANCH" =~ ^jules/ ]]; then
            echo "mode=collaborative" >> $GITHUB_OUTPUT
            echo "agent=@jules" >> $GITHUB_OUTPUT
          else
            echo "mode=autonomous" >> $GITHUB_OUTPUT
            echo "agent=none" >> $GITHUB_OUTPUT
          fi

      - name: Checkout
        if: steps.check-key.outputs.available == 'true'
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          ref: ${{ needs.detect-ai-feedback.outputs.pr_branch }}
          fetch-depth: 0
          token: ${{ secrets.CI_GITHUB_TOKEN }}
          persist-credentials: false

      - name: Run Auto-Heal
        if: steps.check-key.outputs.available == 'true'
        uses: anthropics/claude-code-action@b17b541bbc4d94ffa42edf2e2384ffe702e59370
        env:
          AI_AGENTS: ${{ needs.detect-ai-feedback.outputs.ai_agents }}
          PR_NUMBER: ${{ needs.detect-ai-feedback.outputs.pr_number }}
          PR_BRANCH: ${{ needs.detect-ai-feedback.outputs.pr_branch }}
          FEEDBACK_TYPE: ${{ needs.detect-ai-feedback.outputs.feedback_type }}
          HEAL_MODE: ${{ steps.strategy.outputs.mode }}
          TARGET_AGENT: ${{ steps.strategy.outputs.agent }}
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.CI_GITHUB_TOKEN }}
          track_progress: true
          allowed_bots: "cursor[bot],jules[bot],google-labs-jules[bot],copilot-swe-agent[bot],dependabot[bot],renovate[bot],github-actions[bot],coderabbitai[bot]"
          
          prompt: |
            # AUTO-HEAL TRIGGER
            
            New AI agent feedback has been posted on PR #${{ env.PR_NUMBER }}.
            
            ## Feedback Details
            - **AI Agents**: ${{ env.AI_AGENTS }}
            - **PR Number**: ${{ env.PR_NUMBER }}
            - **PR Branch**: ${{ env.PR_BRANCH }}
            - **Feedback Type**: ${{ env.FEEDBACK_TYPE }}
            - **Healing Mode**: ${{ env.HEAL_MODE }}
            
            ## Your Task
            
            ${{ steps.strategy.outputs.mode == 'collaborative' && format('
            ### COLLABORATIVE HEALING MODE
            
            This is a {0} PR. You should **coordinate with {0}** rather than making direct changes.
            
            **Steps:**
            1. **READ** the latest feedback:
               ```bash
               # Get latest comments
               gh pr view {1} --json comments,reviews | jq ''.comments[-5:],.reviews[-3:]''
               
               # Get check status if CI failure
               gh pr checks {1}
               ```
            
            2. **SYNTHESIZE** the feedback:
               - What is the actual issue?
               - Is it actionable and realistic?
               - Is it applicable to this PR?
               - What is the priority level (Critical/High/Medium/Low)?
               - Are there any false positives?
            
            3. **COMMUNICATE** with {0}:
               - Post a clear, actionable comment
               - Tag {0} directly
               - Explain what needs to be fixed and WHY
               - Provide specific recommendations
               - Ask for confirmation when done
            
            **Example response**:
            ```bash
            gh pr comment {1} --body "
            {0}, new feedback from {2}:
            
            **Issue**: <clear description>
            **Priority**: Critical/High/Medium/Low
            **Location**: file.ts:line
            
            **Recommendation**:
            <specific actionable steps>
            
            **Why this matters**:
            <explain the impact>
            
            Please address this and let me know when ready for re-check.
            "
            ```
            ', steps.strategy.outputs.agent, needs.detect-ai-feedback.outputs.pr_number, needs.detect-ai-feedback.outputs.ai_agents) || '
            ### AUTONOMOUS HEALING MODE
            
            This is a standard PR. You have **full authority to make direct changes**.
            
            **Steps:**
            
            1. **READ** the latest feedback:
               ```bash
               # Get latest comments and reviews
               gh pr view ${{ env.PR_NUMBER }} --json comments,reviews | jq ''.comments[-5:],.reviews[-3:]''
               
               # If CodeQL alert, get details
               gh api /repos/${{ github.repository }}/code-scanning/alerts?state=open&pr=${{ env.PR_NUMBER }}
               
               # If CI failure, get logs
               gh run list --branch ${{ env.PR_BRANCH }} --limit 3
               gh run view <run-id> --log-failed
               ```
            
            2. **SYNTHESIZE** feedback quality:
               - Is it actionable? Can I fix this?
               - Is it realistic? Is this actually a problem?
               - Is it applicable? Does it apply to THIS PR?
               - Priority level? Critical > High > Medium > Low
               - False positive? Should I ignore it?
            
            3. **ACT** - Implement the fix:
               - Make minimal, targeted changes
               - Focus on the specific issue raised
               - Don''t over-engineer the solution
               - Use existing patterns from the codebase
            
            4. **VERIFY** your changes:
               - Run relevant tests locally if possible
               - Check that build still works
               - Ensure no new issues introduced
               - Commit with clear message
            
            5. **COMMIT & PUSH**:
               ```bash
               git add <changed-files>
               git commit -m "fix: address <agent> feedback - <brief description>"
               git push
               ```
            
            6. **ITERATE** if needed:
               - Wait for CI to complete
               - Check if issue is resolved
               - If not, try again with different approach
            '}}
            
            ## Available Tools
            
            ```bash
            # Read PR feedback
            gh pr view ${{ env.PR_NUMBER }} --json comments,reviews,statusCheckRollup
            
            # Read CodeQL alerts
            gh api /repos/${{ github.repository }}/code-scanning/alerts?state=open&pr=${{ env.PR_NUMBER }}
            
            # Read CI logs
            gh run list --branch ${{ env.PR_BRANCH }}
            gh run view <run-id> --log-failed
            
            # Make changes (autonomous mode only)
            # Use Read, Edit, Write tools
            
            # Commit (autonomous mode only)
            git add .
            git commit -m "fix: <description>"
            git push
            
            # Comment (both modes)
            gh pr comment ${{ env.PR_NUMBER }} --body "<message>"
            ```
            
            ## Success Criteria
            
            - ✅ Feedback has been read and understood
            - ✅ Issue has been addressed (or communicated)
            - ✅ No new issues introduced
            - ✅ Changes are tested (if applicable)
            
            **Keep going until the issue is completely resolved.**

          claude_args: |
            --max-turns 30
            --model claude-haiku-4-5-20251001
            --allowedTools "Bash(gh:*),Bash(git:*),Read,Write,Edit,GlobTool,GrepTool,BatchTool,mcp__github__get_pull_request,mcp__github__get_pull_request_diff,mcp__github__add_pull_request_comment,mcp__github__get_file_contents,mcp__github_ci__get_ci_status,mcp__github_ci__get_workflow_run_details,mcp__github_ci__download_job_log"
