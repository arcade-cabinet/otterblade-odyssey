name: Unified Auto-Heal

# Simplified auto-heal system that actually works
# Fixes all Priority 1 security and functionality issues from reviews

on:
  schedule:
    - cron: '0 0 * * *'  # Nightly at midnight UTC
  workflow_run:
    workflows: ["CI"]
    types: [completed]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to fix (optional)'
        required: false

permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  auto-heal:
    name: Auto-Heal CI Failures
    if: |
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'failure') ||
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Detect failure context
        id: detect
        env:
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}
          # SECURITY FIX: Use env vars to prevent code injection
          HEAD_BRANCH: ${{ github.event.workflow_run.head_branch }}
          HEAD_REPO: ${{ github.event.workflow_run.head_repository.full_name }}
          BASE_REPO: ${{ github.event.workflow_run.repository.full_name }}
          RUN_ID: ${{ github.event.workflow_run.id }}
        run: |
          # Check if fork (skip auto-fix for security)
          if [ -n "$HEAD_REPO" ] && [ "$HEAD_REPO" != "$BASE_REPO" ]; then
            echo "üîí Fork PR detected - skipping auto-fix for security"
            echo "is_fork=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "is_fork=false" >> $GITHUB_OUTPUT

          # Get failure context based on trigger
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            echo "üìã CI failure detected in workflow run"
            BRANCH="$HEAD_BRANCH"

            # Get PR number for this branch
            PR_NUM=$(gh pr list --repo "${{ github.repository }}" --head "$BRANCH" --json number --jq '.[0].number // empty' 2>/dev/null || echo "")

            # Fetch failure logs
            LOGS=$(gh run view "$RUN_ID" --repo "${{ github.repository }}" --log-failed 2>&1 | tail -500 || echo "Could not fetch logs")

            CONTEXT="CI Failure in workflow run $RUN_ID
Branch: $BRANCH
PR: ${PR_NUM:-none}
URL: ${{ github.event.workflow_run.html_url }}

Failure Logs:
$LOGS"

          elif [ "${{ github.event_name }}" = "schedule" ]; then
            echo "üåô Running nightly scan for failing PRs..."

            # Find open PRs with failing CI
            FAILING_PR=$(gh pr list --repo "${{ github.repository }}" \
              --json number,headRefName,statusCheckRollup \
              --jq '.[] | select(.statusCheckRollup[]? | select(.conclusion == "FAILURE")) | "\(.number):\(.headRefName)"' \
              2>/dev/null | head -1)

            if [ -z "$FAILING_PR" ]; then
              echo "‚úÖ No failing PRs found during nightly scan"
              exit 0
            fi

            PR_NUM=$(echo "$FAILING_PR" | cut -d: -f1)
            BRANCH=$(echo "$FAILING_PR" | cut -d: -f2)

            CONTEXT="Nightly scan detected failing PR #$PR_NUM
Branch: $BRANCH"

          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ -n "${{ inputs.pr_number }}" ]; then
              PR_NUM="${{ inputs.pr_number }}"
              BRANCH=$(gh pr view "$PR_NUM" --repo "${{ github.repository }}" --json headRefName --jq '.headRefName')
              CONTEXT="Manual trigger for PR #$PR_NUM"
            else
              echo "‚ùå Manual trigger requires pr_number input"
              exit 1
            fi
          fi

          # Output results
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "pr_number=$PR_NUM" >> $GITHUB_OUTPUT
          {
            echo "failure_context<<EOF"
            echo "$CONTEXT"
            echo "EOF"
          } >> $GITHUB_OUTPUT

          echo "‚úÖ Detection complete: PR=$PR_NUM, branch=$BRANCH"

      - name: Checkout branch
        if: steps.detect.outputs.is_fork == 'false' && steps.detect.outputs.branch != ''
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.detect.outputs.branch }}
          fetch-depth: 0
          token: ${{ secrets.CI_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        if: steps.detect.outputs.is_fork == 'false' && steps.detect.outputs.branch != ''
        uses: actions/setup-node@v4
        with:
          node-version: '25'

      - name: Setup pnpm
        if: steps.detect.outputs.is_fork == 'false' && steps.detect.outputs.branch != ''
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup git identity
        if: steps.detect.outputs.is_fork == 'false' && steps.detect.outputs.branch != ''
        run: |
          git config --global user.email "auto-heal[bot]@users.noreply.github.com"
          git config --global user.name "Auto-Heal Bot"

      - name: Fix with Claude Sonnet 4.5
        if: steps.detect.outputs.is_fork == 'false' && steps.detect.outputs.branch != ''
        uses: anthropics/claude-code-action@v1
        with:
          model: claude-sonnet-4-5-20250102
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.CI_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}
          prompt: |
            You are a CI/CD expert fixing build and test failures for the Otterblade Odyssey project.

            ## Project Context
            - Tech stack: Astro 5.x + Solid.js + Matter.js
            - Package manager: pnpm ONLY (never npm/yarn)
            - Language: JavaScript (ES2022)
            - Node.js: v25

            ## Failure Context
            ${{ steps.detect.outputs.failure_context }}

            ## Your Task
            1. Analyze the failure logs and identify the root cause
            2. Implement the MINIMAL fix required to resolve the issue
            3. Run tests to validate your fix works: `pnpm test`
            4. If tests pass, commit your changes with a clear message

            ## Rules
            - Fix ONLY what's broken (no refactoring, no "improvements")
            - Use pnpm for all package operations
            - Ensure tests pass before committing
            - Use descriptive commit messages explaining the fix
            - Include Co-authored-by trailer: "Co-authored-by: Auto-Heal Bot <auto-heal[bot]@users.noreply.github.com>"

            ## Important
            - Do NOT use [skip ci] in commit messages - we need CI to validate the fix
            - Do NOT make changes to workflow files in .github/workflows/
            - If you cannot fix the issue, explain why in detail
          claude_args: |
            --allowedTools "Edit,MultiEdit,Write,Read,Glob,Grep,LS,Bash(pnpm:*),Bash(node:*),Bash(git:*)"

      - name: Verify and push fix
        if: steps.detect.outputs.is_fork == 'false' && steps.detect.outputs.branch != ''
        env:
          BRANCH: ${{ steps.detect.outputs.branch }}
        run: |
          # Check if there are changes to push
          if git diff --quiet && git diff --staged --quiet; then
            echo "‚ÑπÔ∏è No changes to push"
            echo "Claude either determined no fix was needed or couldn't resolve the issue"
            exit 0
          fi

          # Show what's being pushed
          echo "üìù Changes to be pushed:"
          git --no-pager diff --stat

          # Push changes (WITHOUT [skip ci] so CI can validate)
          git push origin "$BRANCH"
          echo "‚úÖ Fix pushed to $BRANCH - CI will now validate the fix"

      - name: Comment on PR (success)
        if: |
          steps.detect.outputs.is_fork == 'false' &&
          steps.detect.outputs.pr_number != '' &&
          success()
        env:
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}
          PR_NUM: ${{ steps.detect.outputs.pr_number }}
        run: |
          gh pr comment "$PR_NUM" --repo "${{ github.repository }}" --body "## ü§ñ Auto-Heal Applied

The auto-heal system analyzed the CI failure and pushed a fix using Claude Sonnet 4.5.

**Status:** ‚úÖ Fix committed and pushed
**Branch:** \`${{ steps.detect.outputs.branch }}\`
**Validation:** CI is re-running to verify the fix works

If CI still fails, the auto-heal system will attempt another fix on the next run.

---
<sub>ü§ñ Unified Auto-Heal System</sub>"

      - name: Comment on PR (failure)
        if: |
          steps.detect.outputs.is_fork == 'false' &&
          steps.detect.outputs.pr_number != '' &&
          failure()
        env:
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}
          PR_NUM: ${{ steps.detect.outputs.pr_number }}
        run: |
          gh pr comment "$PR_NUM" --repo "${{ github.repository }}" --body "## ‚ö†Ô∏è Auto-Heal Failed

The auto-heal system attempted to fix the CI failure but encountered an issue.

**Status:** ‚ùå Could not generate or apply fix
**Branch:** \`${{ steps.detect.outputs.branch }}\`

Please review the [workflow run logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.

---
<sub>ü§ñ Unified Auto-Heal System</sub>"

      - name: Notify fork PRs
        if: steps.detect.outputs.is_fork == 'true' && steps.detect.outputs.pr_number != ''
        env:
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}
          PR_NUM: ${{ steps.detect.outputs.pr_number }}
        run: |
          gh pr comment "$PR_NUM" --repo "${{ github.repository }}" --body "‚ö†Ô∏è **Auto-heal unavailable for fork PRs**

For security reasons, automatic CI fixes are disabled for pull requests from forked repositories.
Please fix the CI failure manually.

---
<sub>ü§ñ Unified Auto-Heal System</sub>"
