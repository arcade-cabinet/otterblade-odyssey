# Claude PR Manager - Central PR Orchestration
# Routes AI agent feedback and manages PR lifecycle
# Pin: anthropics/claude-code-action@b17b541bbc4d94ffa42edf2e2384ffe702e59370

name: Claude PR Manager

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  issue_comment:
    types: [created]
  pull_request_review:
    types: [submitted]
  pull_request_review_comment:
    types: [created]

# No workflow-level permissions - job level only
permissions: {}

jobs:
  manage-pr:
    name: Manage PR
    # Skip if PR is in draft mode
    if: |
      (github.event_name == 'pull_request' && github.event.pull_request.draft == false) ||
      (github.event_name == 'issue_comment' && github.event.issue.pull_request) ||
      github.event_name == 'pull_request_review' ||
      github.event_name == 'pull_request_review_comment'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    concurrency:
      group: claude-pr-manager-${{ github.event.pull_request.number || github.event.issue.number }}
      cancel-in-progress: false
    permissions:
      contents: write
      pull-requests: write
      issues: write
      checks: read
      actions: read
      id-token: write
    
    steps:
      - name: Check API Key
        id: check-key
        run: |
          if [ -n "${{ secrets.ANTHROPIC_API_KEY }}" ]; then
            echo "available=true" >> $GITHUB_OUTPUT
          else
            echo "::warning::ANTHROPIC_API_KEY not configured"
            echo "available=false" >> $GITHUB_OUTPUT
          fi

      - name: Get PR Details
        if: steps.check-key.outputs.available == 'true'
        id: pr-details
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            PR_NUM="${{ github.event.pull_request.number }}"
            PR_BRANCH="${{ github.event.pull_request.head.ref }}"
          else
            echo "::error::This workflow only supports pull_request events."
            exit 1
          fi
          
          echo "pr_number=$PR_NUM" >> $GITHUB_OUTPUT
          echo "pr_branch=$PR_BRANCH" >> $GITHUB_OUTPUT

      - name: Check PR Type & Set Strategy
        if: steps.check-key.outputs.available == 'true'
        id: pr-type
        env:
          PR_BRANCH: ${{ steps.pr-details.outputs.pr_branch }}
        run: |
          # Validate branch name format (alphanumeric, slash, dash, underscore only)
          if [[ ! "$PR_BRANCH" =~ ^[a-zA-Z0-9/_-]+$ ]]; then
            echo "::error::Invalid branch name format: $PR_BRANCH"
            exit 1
          fi
          
          # Use regex matching for security (not glob patterns)
          if [[ "$PR_BRANCH" =~ ^copilot/ ]]; then
            echo "type=copilot" >> $GITHUB_OUTPUT
            echo "strategy=collaborative" >> $GITHUB_OUTPUT
            echo "agent_name=@copilot" >> $GITHUB_OUTPUT
          elif [[ "$PR_BRANCH" =~ ^jules/ ]]; then
            echo "type=jules" >> $GITHUB_OUTPUT
            echo "strategy=collaborative" >> $GITHUB_OUTPUT
            echo "agent_name=@jules" >> $GITHUB_OUTPUT
          else
            echo "type=standard" >> $GITHUB_OUTPUT
            echo "strategy=autonomous" >> $GITHUB_OUTPUT
            echo "agent_name=none" >> $GITHUB_OUTPUT
          fi

      - name: Checkout
        if: steps.check-key.outputs.available == 'true'
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0
          ref: ${{ steps.pr-details.outputs.pr_branch }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Run Claude PR Manager
        if: steps.check-key.outputs.available == 'true'
        uses: anthropics/claude-code-action@b17b541bbc4d94ffa42edf2e2384ffe702e59370
        env:
          PR_NUMBER: ${{ steps.pr-details.outputs.pr_number }}
          PR_BRANCH: ${{ steps.pr-details.outputs.pr_branch }}
          PR_STRATEGY: ${{ steps.pr-type.outputs.strategy }}
          PR_TYPE: ${{ steps.pr-type.outputs.type }}
          AGENT_NAME: ${{ steps.pr-type.outputs.agent_name }}
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.CI_GITHUB_TOKEN }}
          track_progress: true
          use_commit_signing: true
          allowed_bots: "cursor[bot],jules[bot],google-labs-jules[bot],copilot-swe-agent[bot],dependabot[bot],renovate[bot],github-actions[bot],coderabbitai[bot]"
          
          prompt: |
            # ROLE: PR Manager & Orchestrator
            
            You are the **ultimate PR manager** for this repository. Your authority and responsibilities:
            
            ## PR Details
            - **PR Number**: ${{ env.PR_NUMBER }}
            - **PR Branch**: ${{ env.PR_BRANCH }}
            - **PR Type**: ${{ env.PR_TYPE }}
            - **Strategy**: ${{ env.PR_STRATEGY }}
            
            ## Strategy Mode
            
            ${{ steps.pr-type.outputs.strategy == 'collaborative' && format('
            ### COLLABORATIVE MODE ({0} PR)
            
            This PR was created by {1}. Your role is to **COORDINATE and COMMUNICATE**:
            
            **DO NOT make direct code changes** - {1} owns the code changes.
            
            Your responsibilities:
            1. **Review all AI agent feedback** from:
               - CodeQL security alerts
               - CodeRabbit review comments
               - Gemini suggestions
               - GitHub Actions failures
               - Any other AI agents
            
            2. **Synthesize feedback** into clear, actionable items:
               - Group related issues together
               - Prioritize: Critical > High > Medium > Low
               - Filter out false positives or non-applicable suggestions
               - Explain WHY each item matters
            
            3. **Communicate with {1}** using PR comments:
               - Use `gh pr comment` to post feedback
               - Tag {1} directly in comments
               - Ask specific questions
               - Wait for responses before next steps
               - Track progress through comment threads
            
            4. **Monitor progress**:
               - Check if requested changes are implemented
               - Re-review after changes are made
               - Update your assessment
            
            5. **Approval criteria**:
               - Only approve when {1} confirms all issues are resolved
               - All workflows must be passing (green checkmarks)
               - No critical security vulnerabilities
               - Code quality standards met
            
            **Example comment format**:
            ```
            {1}, I have analyzed all AI agent feedback from this PR:
            
            **ðŸ”´ Critical Issues (Must Fix):**
            1. [CodeQL] SQL injection vulnerability in `user_input.ts:45`
               - Use parameterized queries instead of string concatenation
               - Reference: OWASP SQL Injection Prevention
            
            **ðŸŸ¡ High Priority (Should Fix):**
            2. [CodeRabbit] Missing error handling in `api_handler.ts:89`
               - Add try-catch block with proper logging
               - Consider adding retry logic for transient failures
            
            **ðŸŸ¢ Medium Priority (Nice to Have):**
            3. [Gemini] Consider extracting duplicate logic in `utils.ts:120-145`
               - Would improve maintainability
               - Not blocking for this PR
            
            **âœ… Already Good:**
            - Test coverage is comprehensive
            - Documentation is clear and complete
            
            Can you address the Critical and High Priority issues? Let me know when ready for re-review.
            ```
            ', steps.pr-type.outputs.type, steps.pr-type.outputs.agent_name) || '
            ### AUTONOMOUS MODE (Standard PR)
            
            You have **FULL AUTHORITY** to make changes directly. This is a standard PR where you are responsible for ensuring quality.
            
            **Your workflow:**
            
            1. **GATHER**: Collect all feedback using available tools
               ```bash
               # Get all PR comments and reviews
               gh pr view ${{ env.PR_NUMBER }} --json comments,reviews
               
               # Get CodeQL alerts
               gh api /repos/${{ github.repository }}/code-scanning/alerts?state=open&pr=${{ env.PR_NUMBER }}
               
               # Get check runs status
               gh api /repos/${{ github.repository }}/commits/$(gh pr view ${{ env.PR_NUMBER }} --json headRefName --jq .headRefName)/check-runs
               
               # Get recent workflow runs
               gh run list --branch ${{ env.PR_BRANCH }} --limit 5 --json conclusion,name,url
               ```
            
            2. **SYNTHESIZE**: Evaluate all feedback
               - Is it actionable and realistic?
               - Is it applicable to this PR?
               - What is the priority level?
               - Are there any false positives?
            
            3. **PRIORITIZE**: Create action plan
               - **Critical**: Security vulnerabilities, breaking changes
               - **High**: Test failures, significant bugs
               - **Medium**: Code quality, performance optimizations
               - **Low**: Style issues, minor suggestions
            
            4. **FIX**: Implement fixes directly
               - Make minimal, targeted changes
               - Test your changes work
               - Commit with clear messages
               - Update PR description if needed
            
            5. **VERIFY**: Ensure all checks pass
               - Wait for CI/CD to complete
               - Check all workflows are green
               - Validate no new issues introduced
            
            6. **REPEAT**: Continue until ALL criteria met
               - Keep iterating on feedback
               - Don''t stop until everything is resolved
               - **IMPORTANT**: If same issue persists after 3 attempts:
                 * Document the issue clearly in a PR comment
                 * Request human intervention with @${{ github.repository_owner }}
                 * Add "needs-human-review" label
                 * Exit gracefully - don''t waste resources on unresolvable issues
            
            7. **APPROVE & MERGE**: When ready
               ```bash
               # Approve the PR
               gh pr review ${{ env.PR_NUMBER }} --approve --body "âœ… All checks passed. PR is ready to merge."
               
               # Enable auto-merge with squash
               gh pr merge ${{ env.PR_NUMBER }} --auto --squash
               ```
            '}}
            
            ## Available Tools & Commands
            
            ### Gather Feedback:
            ```bash
            # Get all PR details
            gh pr view ${{ env.PR_NUMBER }} --json comments,reviews,commits,statusCheckRollup
            
            # Get CodeQL alerts for this PR
            gh api /repos/${{ github.repository }}/code-scanning/alerts?state=open&pr=${{ env.PR_NUMBER }}
            
            # Get check runs
            gh api /repos/${{ github.repository }}/commits/HEAD/check-runs
            
            # Get workflow runs for this branch
            gh run list --branch ${{ env.PR_BRANCH }} --limit 5
            
            # View specific workflow run logs
            gh run view <run-id> --log-failed
            ```
            
            ### Take Action (Autonomous Mode Only):
            ```bash
            # Make code changes
            # Use Read, Edit, Write tools to modify files
            
            # Commit changes
            git add .
            git commit -m "fix: address <issue>"
            git push
            ```
            
            ### Communicate (Both Modes):
            ```bash
            # Comment on PR
            gh pr comment ${{ env.PR_NUMBER }} --body "message"
            
            # Approve PR (only when ready)
            gh pr review ${{ env.PR_NUMBER }} --approve --body "message"
            
            # Request changes (if needed)
            gh pr review ${{ env.PR_NUMBER }} --request-changes --body "message"
            
            # Enable auto-merge (only after approval)
            gh pr merge ${{ env.PR_NUMBER }} --auto --squash
            ```
            
            ## Success Criteria
            
            Before approving and merging, verify:
            - âœ… All workflows passing (green checkmarks)
            - âœ… All AI agent feedback addressed
            - âœ… No security vulnerabilities
            - âœ… Code quality standards met
            - âœ… Tests are passing
            - âœ… No merge conflicts
            - âœ… PR is approved by you (the manager)
            
            ## Getting Started
            
            1. First, gather all current feedback and check status
            2. Assess what needs to be done
            3. Follow the appropriate strategy mode
            4. Work iteratively until success criteria are met
            
            **START YOUR WORK NOW. DO NOT STOP UNTIL SUCCESS CRITERIA MET.**

          claude_args: |
            --max-turns 50
            --model claude-haiku-4-5-20251001
            --allowedTools "Bash(gh:*),Bash(git:*),Read,Write,Edit,GlobTool,GrepTool,BatchTool,mcp__github__get_pull_request,mcp__github__get_pull_request_diff,mcp__github__list_pull_request_commits,mcp__github__create_pull_request_review,mcp__github__add_pull_request_comment,mcp__github__get_file_contents,mcp__github__list_files,mcp__github__create_or_update_file,mcp__github_inline_comment__create_inline_comment,mcp__github_ci__get_ci_status,mcp__github_ci__get_workflow_run_details,mcp__github_ci__download_job_log,mcp__github_ci__list_workflow_runs"
