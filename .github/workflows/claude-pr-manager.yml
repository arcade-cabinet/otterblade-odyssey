# Claude PR Manager - Central PR Orchestration
# Routes AI agent feedback and manages PR lifecycle
# Pin: anthropics/claude-code-action@b17b541bbc4d94ffa42edf2e2384ffe702e59370

name: Claude PR Manager

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  issue_comment:
    types: [created]
  pull_request_review:
    types: [submitted]
  pull_request_review_comment:
    types: [created]

# No workflow-level permissions - job level only
permissions: {}

jobs:
  manage-pr:
    name: Manage PR
    # Skip if PR is in draft mode
    if: |
      (github.event_name == 'pull_request' && github.event.pull_request.draft == false) ||
      (github.event_name == 'issue_comment' && github.event.issue.pull_request) ||
      github.event_name == 'pull_request_review' ||
      github.event_name == 'pull_request_review_comment'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    concurrency:
      group: claude-pr-manager-${{ github.event.pull_request.number || github.event.issue.number }}
      cancel-in-progress: false
    permissions:
      contents: write
      pull-requests: write
      issues: write
      checks: read
      actions: read
      id-token: write
    
    steps:
      - name: Check API Key
        id: check-key
        run: |
          if [ -n "${{ secrets.ANTHROPIC_API_KEY }}" ]; then
            echo "available=true" >> $GITHUB_OUTPUT
          else
            echo "::warning::ANTHROPIC_API_KEY not configured"
            echo "available=false" >> $GITHUB_OUTPUT
          fi

      - name: Get PR Details
        if: steps.check-key.outputs.available == 'true'
        id: pr-details
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const eventName = context.eventName;
            let prData = null;

            if (eventName === 'pull_request') {
              prData = context.payload.pull_request;
            } else if (eventName === 'pull_request_review' || eventName === 'pull_request_review_comment') {
              prData = context.payload.pull_request;
} else if (eventName === 'issue_comment' && context.payload.issue?.pull_request) {
  try {
    const { data } = await github.rest.pulls.get({
      owner: context.repo.owner,
      repo: context.repo.repo,
      pull_number: context.payload.issue.number,
    });
    prData = data;
  } catch (error) {
    core.setFailed(`Failed to fetch PR details: ${error.message}`);
    return;
  }
            }

if (!prData) {
  core.info(`Event name: ${eventName}, context keys: ${Object.keys(context.payload).join(', ')}`);
  core.setFailed(`Unsupported event: ${eventName}`);
  return;
}

            core.setOutput('pr_number', prData.number);
            core.setOutput('pr_branch', prData.head.ref);

      - name: Check PR Type & Set Strategy
        if: steps.check-key.outputs.available == 'true'
        id: pr-type
        env:
          PR_BRANCH: ${{ steps.pr-details.outputs.pr_branch }}
        run: |
          # Validate branch name format (alphanumeric, slash, dash, underscore only)
          if [[ ! "$PR_BRANCH" =~ ^[a-zA-Z0-9/_-]+$ ]]; then
            echo "::error::Invalid branch name format: $PR_BRANCH"
            exit 1
          fi
          
          # Use regex matching for security (not glob patterns)
          if [[ "$PR_BRANCH" =~ ^copilot/ ]]; then
            echo "type=copilot" >> $GITHUB_OUTPUT
            echo "strategy=collaborative" >> $GITHUB_OUTPUT
            echo "agent_name=@copilot" >> $GITHUB_OUTPUT
          elif [[ "$PR_BRANCH" =~ ^jules/ ]]; then
            echo "type=jules" >> $GITHUB_OUTPUT
            echo "strategy=collaborative" >> $GITHUB_OUTPUT
            echo "agent_name=@jules" >> $GITHUB_OUTPUT
          else
            echo "type=standard" >> $GITHUB_OUTPUT
            echo "strategy=autonomous" >> $GITHUB_OUTPUT
            echo "agent_name=none" >> $GITHUB_OUTPUT
          fi

      - name: Checkout
        if: steps.check-key.outputs.available == 'true'
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0
          ref: ${{ steps.pr-details.outputs.pr_branch }}
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: false

      - name: Load PR Manager Prompt
        if: steps.check-key.outputs.available == 'true'
        id: load-prompt
        run: |
          PROMPT=$(cat .github/prompts/pr-manager-prompt.md)
          echo "prompt<<EOF" >> $GITHUB_OUTPUT
          echo "$PROMPT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Run Claude PR Manager
        if: steps.check-key.outputs.available == 'true'
        uses: anthropics/claude-code-action@b17b541bbc4d94ffa42edf2e2384ffe702e59370
        env:
          PR_NUMBER: ${{ steps.pr-details.outputs.pr_number }}
          PR_BRANCH: ${{ steps.pr-details.outputs.pr_branch }}
          PR_STRATEGY: ${{ steps.pr-type.outputs.strategy }}
          PR_TYPE: ${{ steps.pr-type.outputs.type }}
          AGENT_NAME: ${{ steps.pr-type.outputs.agent_name }}
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.CI_GITHUB_TOKEN }}
          track_progress: true
          use_commit_signing: true
          allowed_bots: "cursor[bot],jules[bot],google-labs-jules[bot],copilot-swe-agent[bot],dependabot[bot],renovate[bot],github-actions[bot],coderabbitai[bot]"

          prompt: |
            ${{ steps.load-prompt.outputs.prompt }}

            ## PR Context
            - PR Number: ${{ env.PR_NUMBER }}
            - PR Branch: ${{ env.PR_BRANCH }}
            - PR Type: ${{ env.PR_TYPE }}
            - Strategy: ${{ env.PR_STRATEGY }}
            - Agent Name: ${{ env.AGENT_NAME }}

            **Replace placeholders in the prompt above with these actual values when executing commands.**

          claude_args: |
            --max-turns 50
            --model claude-haiku-4-5-20251001
            --allowedTools "Bash(gh:*),Bash(git:*),Read,Write,Edit,GlobTool,GrepTool,BatchTool,mcp__github__get_pull_request,mcp__github__get_pull_request_diff,mcp__github__list_pull_request_commits,mcp__github__create_pull_request_review,mcp__github__add_pull_request_comment,mcp__github__get_file_contents,mcp__github__list_files,mcp__github__create_or_update_file,mcp__github_inline_comment__create_inline_comment,mcp__github_ci__get_ci_status,mcp__github_ci__get_workflow_run_details,mcp__github_ci__download_job_log,mcp__github_ci__list_workflow_runs"
