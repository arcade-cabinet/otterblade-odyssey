name: Jules PR Auto-Triage

# This workflow auto-triages PRs created by Jules agents
# and triggers Claude review for automated merging

on:
  pull_request:
    types: [opened, labeled]

# No workflow-level permissions - all permissions defined at job level
permissions: {}

jobs:
  detect-jules-pr:
    runs-on: ubuntu-latest
    if: |
      contains(github.event.pull_request.labels.*.name, 'jules-pr') ||
      startsWith(github.event.pull_request.head.ref, 'jules/')
    permissions:
      contents: read
      pull-requests: write
      issues: write
    outputs:
      agent_type: ${{ steps.detect.outputs.agent_type }}
      priority: ${{ steps.detect.outputs.priority }}
    steps:
      - name: Detect Jules Agent Type
        id: detect
        env:
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BRANCH: ${{ github.event.pull_request.head.ref }}
        run: |
          # Detect agent type from PR title emoji or branch name
          if [[ "$PR_TITLE" == *"âš¡"* ]] || [[ "$PR_BRANCH" == *"bolt"* ]]; then
            echo "agent_type=bolt" >> $GITHUB_OUTPUT
            echo "priority=medium" >> $GITHUB_OUTPUT
          elif [[ "$PR_TITLE" == *"ðŸŽ¨"* ]] || [[ "$PR_BRANCH" == *"palette"* ]]; then
            echo "agent_type=palette" >> $GITHUB_OUTPUT
            echo "priority=low" >> $GITHUB_OUTPUT
          elif [[ "$PR_TITLE" == *"ðŸ“š"* ]] || [[ "$PR_BRANCH" == *"scribe"* ]]; then
            echo "agent_type=scribe" >> $GITHUB_OUTPUT
            echo "priority=low" >> $GITHUB_OUTPUT
          elif [[ "$PR_TITLE" == *"ðŸ›¡ï¸"* ]] || [[ "$PR_BRANCH" == *"sentinel"* ]]; then
            echo "agent_type=sentinel" >> $GITHUB_OUTPUT
            # Check for CRITICAL in title
            if [[ "$PR_TITLE" == *"CRITICAL"* ]]; then
              echo "priority=critical" >> $GITHUB_OUTPUT
            else
              echo "priority=high" >> $GITHUB_OUTPUT
            fi
          elif [[ "$PR_TITLE" == *"ðŸ›"* ]] || [[ "$PR_BRANCH" == *"fix"* ]]; then
            echo "agent_type=bug-fixer" >> $GITHUB_OUTPUT
            echo "priority=high" >> $GITHUB_OUTPUT
          elif [[ "$PR_TITLE" == *"ðŸ§¹"* ]] || [[ "$PR_BRANCH" == *"cleanup"* ]]; then
            echo "agent_type=cleanup" >> $GITHUB_OUTPUT
            echo "priority=low" >> $GITHUB_OUTPUT
          else
            echo "agent_type=general" >> $GITHUB_OUTPUT
            echo "priority=medium" >> $GITHUB_OUTPUT
          fi

      - name: Add Triage Labels
        env:
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          AGENT_TYPE: ${{ steps.detect.outputs.agent_type }}
          PRIORITY: ${{ steps.detect.outputs.priority }}
        run: |
          # Add agent-specific label
          gh pr edit $PR_NUMBER --add-label "agent:${AGENT_TYPE}" || true
          
          # Add priority label
          gh pr edit $PR_NUMBER --add-label "priority:${PRIORITY}" || true
          
          # Add auto-review label to trigger Claude
          gh pr edit $PR_NUMBER --add-label "needs-claude-review" || true
          
          echo "âœ… Triaged Jules PR #$PR_NUMBER"
          echo "   Agent: $AGENT_TYPE"
          echo "   Priority: $PRIORITY"

  trigger-claude-review:
    needs: detect-jules-pr
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write
      actions: read
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          token: ${{ secrets.CI_GITHUB_TOKEN }}

      - name: Request Claude Review
        uses: anthropics/claude-code-action@7145c3e0510bcdbdd29f67cc4a8c1958f1acfa2f # v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.CI_GITHUB_TOKEN }}
          allowed_bots: "*"
          additional_permissions: |
            actions: read
          track_progress: true
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}
            
            ## Jules Agent PR Review
            
            This PR was created by a Jules AI agent (${{ needs.detect-jules-pr.outputs.agent_type }}).
            Priority: ${{ needs.detect-jules-pr.outputs.priority }}
            
            Please review this PR with the following focus:
            
            ### 1. Code Quality
            - Does the code follow project conventions (AGENTS.md, CLAUDE.md)?
            - Are there any obvious bugs or issues?
            - Is the code clean and maintainable?
            
            ### 2. Safety Check
            - Are there any breaking changes?
            - Is the scope appropriate (not too large)?
            - Are there any security concerns?
            
            ### 3. Brand Alignment (for UI changes)
            - Does it follow the warm storybook aesthetic?
            - No neon, sci-fi, or horror elements?
            
            ### 4. Testing
            - Does CI pass?
            - Are changes testable?
            
            ## Action Required
            
            If the PR looks good:
            1. Approve the PR
            2. Add comment: "âœ… LGTM - Approved for merge"
            3. If priority is critical or high, merge immediately
            
            If issues found:
            1. Request changes with specific feedback
            2. Add comment explaining what needs to be fixed
            
          claude_args: |
            --allowedTools "Read,Glob,Grep,LS,Bash(gh:*),mcp__github__get_pull_request,mcp__github__get_pull_request_diff,mcp__github__list_pull_request_commits,mcp__github__create_pull_request_review,mcp__github__merge_pull_request,mcp__github__get_file_contents,mcp__github_inline_comment__create_inline_comment,mcp__github_ci__get_ci_status"

  auto-merge-if-approved:
    needs: [detect-jules-pr, trigger-claude-review]
    runs-on: ubuntu-latest
    if: needs.detect-jules-pr.outputs.priority == 'critical' || needs.detect-jules-pr.outputs.priority == 'high'
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Check and Merge
        env:
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          # Wait for CI to complete
          echo "Waiting for CI checks..."
          sleep 30
          
          # Check if PR is approved
          REVIEW_STATE=$(gh pr view $PR_NUMBER --json reviewDecision --jq '.reviewDecision')
          
          if [[ "$REVIEW_STATE" == "APPROVED" ]]; then
            echo "PR is approved, attempting merge..."
            gh pr merge $PR_NUMBER --squash --auto || echo "Auto-merge enabled, will merge when checks pass"
          else
            echo "PR not yet approved (state: $REVIEW_STATE), skipping auto-merge"
          fi
