name: Jules Weekly Cleanup

on:
  schedule:
    # Run every Monday at 2 AM UTC
    - cron: '0 2 * * 1'
  workflow_dispatch:

# No workflow-level permissions - all permissions defined at job level
permissions: {}

jobs:
  cleanup:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Invoke Jules for Cleanup
        uses: google-labs-code/jules-action@bff7875eaa123cac6742b7cfc51005b95ba4d566 # v1.0.0
        with:
          prompt: |
            # üßπ WEEKLY CLEANUP AGENT - PULL REQUEST REQUIRED

            ## ‚ö†Ô∏è CRITICAL REQUIREMENT
            **YOU MUST CREATE A PULL REQUEST.** This is not optional.
            - If you find cleanup opportunities, create a PR with the improvements
            - If the codebase is already clean, create a PR with a health report markdown file
            - NEVER exit without creating a PR

            ---

            You are performing weekly maintenance on **Otterblade Odyssey: Zephyros Rising**.

            ## Project Context
            - **Tech Stack:** React Three Fiber, Rapier2D, Miniplex ECS, Zustand, Tailwind CSS v4
            - **Package Manager:** pnpm ONLY
            - **Linter:** Biome (strict mode)

            ## Key Directories
            - `client/src/game/` - Game logic
            - `client/src/components/` - UI components
            - `client/src/data/` - JSON content files
            - `server/` - Express server

            ## Focus Areas

            ### 1. Dead Code Removal
            - Unused variables, functions, and components
            - Commented-out code blocks
            - Unreachable code paths

            ### 2. Code Duplication (DRY)
            - Duplicated code blocks ‚Üí refactor into reusable functions
            - Repeated patterns in ECS systems

            ### 3. Complexity Reduction
            - Functions over 50 lines ‚Üí break down
            - Components over 200 lines ‚Üí split
            - Nested conditionals ‚Üí simplify

            ### 4. Naming Improvements
            - Unclear names ‚Üí descriptive names
            - Inconsistent conventions ‚Üí standardize

            ### 5. Type Safety
            - `any` types ‚Üí proper typing
            - Missing JSDoc ‚Üí add documentation

            ## File Size Limits
            - Components: Max 200 lines
            - Utilities: Max 150 lines
            - Systems: Max 300 lines

            ## MANDATORY PULL REQUEST FORMAT

            **Branch Name:** `jules/cleanup-week-{{week-number}}`

            **PR Title:** `üßπ Cleanup: Weekly maintenance (Week {{week}})`

            **PR Body MUST include:**
            ```markdown
            ## Summary
            Weekly codebase cleanup and maintenance.

            ## Changes Made
            - [ ] Dead code removal
            - [ ] Duplication reduction
            - [ ] Complexity improvements
            - [ ] Naming fixes
            - [ ] Type safety improvements

            ## Files Changed
            [List of files with brief descriptions]

            ## Verification
            - [ ] Ran `pnpm biome check .`
            - [ ] Ran `pnpm tsc --noEmit`
            - [ ] No functionality changes

            ## Labels
            - `jules-pr`
            - `maintenance`
            - `auto-triage`
            ```

            **PR Labels:** `jules-pr`, `maintenance`, `auto-triage`

            ## If Codebase Is Clean

            Create a PR adding `docs/health-report-{{date}}.md` with:
            - Codebase health score
            - Areas reviewed
            - Metrics (file sizes, complexity)
            - Recommendations for next week
          jules_api_key: ${{ secrets.GOOGLE_JULES_API_KEY }}
          include_commit_log: true
