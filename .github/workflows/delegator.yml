# Delegator - AI Agent Command Router
# Consolidates: ai-delegator.yml, ecosystem-delegator.yml
#
# Handles delegation commands in comments:
# - @claude - delegate to Claude (STAYS in current issue/PR)
#
# All agents work WITHIN the current context - no separate PRs spawned

name: Delegator

on:
  issue_comment:
    types: [created]

  workflow_call:
    inputs:
      comment_body:
        description: 'The comment that triggered delegation'
        required: true
        type: string
      issue_number:
        description: 'Issue number'
        required: true
        type: number
      repository:
        description: 'Repository owner/name'
        required: true
        type: string
    secrets:
      CI_GITHUB_TOKEN:
        required: true
      ANTHROPIC_API_KEY:
        required: false

  workflow_dispatch:
    inputs:
      comment_body:
        description: 'Command (e.g. @claude fix this)'
        required: true
        type: string
      issue_number:
        description: 'Issue number'
        required: true
        type: number
      repository:
        description: 'Repository'
        required: true
        type: string

env:
  TARGET_REPO: ${{ inputs.repository || github.repository }}
  TARGET_ISSUE: ${{ inputs.issue_number || github.event.issue.number }}
  COMMENT_BODY: ${{ inputs.comment_body || github.event.comment.body }}
  # Claude tool allowlist (configurable via repository variables for flexibility)
  # Default includes common development tools with full access
  # Override with CLAUDE_ALLOWED_TOOLS variable to restrict further
  CLAUDE_ALLOWED_TOOLS: ${{ vars.CLAUDE_ALLOWED_TOOLS || 'Edit,MultiEdit,Write,Read,Glob,Grep,LS,Bash(git:*),Bash(pnpm:*),Bash(npm:*),Bash(npx:*),Bash(gh:*),mcp__github__get_issue,mcp__github__update_issue,mcp__github__add_issue_comment,mcp__github__list_issues,mcp__github__search_issues,mcp__github__get_pull_request,mcp__github__get_pull_request_diff,mcp__github__list_pull_request_commits,mcp__github__create_pull_request_review,mcp__github__add_pull_request_comment,mcp__github__get_file_contents,mcp__github__list_files,mcp__github_inline_comment__create_inline_comment,mcp__github_ci__get_ci_status,mcp__github_ci__get_workflow_run_details,mcp__github_ci__download_job_log,mcp__github_ci__list_workflow_runs' }}

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  # ════════════════════════════════════════════════════════════════
  # CLAUDE: @claude mentions in issues/PRs
  # ════════════════════════════════════════════════════════════════
  claude:
    name: Claude Agent
    if: contains(github.event.comment.body, '@claude') || contains(inputs.comment_body, '@claude')
    runs-on: ubuntu-latest
    timeout-minutes: 30
    concurrency:
      group: claude-${{ github.event.issue.number || github.event.pull_request.number || inputs.issue_number }}
      cancel-in-progress: false
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    steps:
      - name: Check API Key
        id: check-key
        run: |
          if [ -n "${{ secrets.ANTHROPIC_API_KEY }}" ]; then
            echo "available=true" >> $GITHUB_OUTPUT
          else
            echo "::warning::ANTHROPIC_API_KEY not configured"
            echo "available=false" >> $GITHUB_OUTPUT
          fi

      - name: Verify Comment Author
        id: verify-author
        if: steps.check-key.outputs.available == 'true'
        env:
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
          COMMENT_AUTHOR: ${{ github.event.comment.user.login || github.actor }}
        run: |
          # Security: Only allow repository collaborators to invoke @claude
          # This prevents unauthorized users from executing arbitrary code changes
          set +e  # Don't exit on error, we want to handle it
          PERMISSION_JSON=$(gh api repos/${{ env.TARGET_REPO }}/collaborators/$COMMENT_AUTHOR/permission 2>&1)
          API_EXIT_CODE=$?
          set -e

          if [ $API_EXIT_CODE -ne 0 ]; then
            # API call failed - user is not a collaborator or API error
            echo "authorized=false" >> $GITHUB_OUTPUT
            echo "::warning::@claude invoked by non-collaborator or API error: $COMMENT_AUTHOR. Ignoring request."
            gh issue comment ${{ env.TARGET_ISSUE }} --repo ${{ env.TARGET_REPO }} \
              --body "⚠️ @$COMMENT_AUTHOR does not have permission to invoke @claude (requires write access or higher)" || true
            exit 0
          fi

          PERMISSION=$(echo "$PERMISSION_JSON" | jq -r '.permission // "none"')
          echo "User: $COMMENT_AUTHOR, Permission: $PERMISSION"

          if [[ "$PERMISSION" =~ ^(admin|write|maintain)$ ]]; then
            echo "authorized=true" >> $GITHUB_OUTPUT
            echo "::notice::@claude invoked by authorized user: $COMMENT_AUTHOR ($PERMISSION)"
          else
            echo "authorized=false" >> $GITHUB_OUTPUT
            echo "::warning::@claude invoked by unauthorized user: $COMMENT_AUTHOR (permission: $PERMISSION). Ignoring request."
            gh issue comment ${{ env.TARGET_ISSUE }} --repo ${{ env.TARGET_REPO }} \
              --body "⚠️ @$COMMENT_AUTHOR does not have permission to invoke @claude (requires write access or higher)" || true
          fi

      - name: Checkout
        if: steps.check-key.outputs.available == 'true' && steps.verify-author.outputs.authorized == 'true'
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          repository: ${{ env.TARGET_REPO }}
          fetch-depth: 1
          token: ${{ secrets.CI_GITHUB_TOKEN }}

      - name: Claude Code Action
        if: steps.check-key.outputs.available == 'true' && steps.verify-author.outputs.authorized == 'true'
        uses: anthropics/claude-code-action@7145c3e0510bcdbdd29f67cc4a8c1958f1acfa2f # v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.CI_GITHUB_TOKEN }}
          allowed_bots: "cursor[bot],copilot-swe-agent[bot],dependabot[bot],renovate[bot],github-actions[bot]"
          additional_permissions: |
            actions: read
          track_progress: true
          prompt: |
            You are helping with ${{ env.TARGET_REPO }}.

            Context: ${{ github.event.issue.pull_request && 'Pull Request' || 'Issue' }} #${{ env.TARGET_ISSUE }}
            Invoked by: @${{ github.event.comment.user.login || github.actor }}

            First, read CLAUDE.md, AGENTS.md, or README.md to understand the project.
            Then address the user's request in their comment.

            IMPORTANT: Work WITHIN this ${{ github.event.issue.pull_request && 'PR' || 'issue' }}.
            Do NOT create separate PRs. Commit fixes directly to the current branch if this is a PR.
          claude_args: |
            --allowedTools "${{ env.CLAUDE_ALLOWED_TOOLS }}"
