# Repository Sync - Idempotent configuration for otterblade-odyssey
# Maintains SUPPLEMENTARY settings that enhance (not conflict with) enterprise rules
name: Repository Sync

on:
  push:
    branches: [main]
    paths:
      - '.github/workflows/repo-sync.yml'
  schedule:
    - cron: '0 4 * * *'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  sync:
    name: Sync Repository Settings
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Configure repository
        env:
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          echo "ğŸ”§ Syncing $REPO settings..."
          
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # ENVIRONMENT: Ensure 'release' environment exists
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          echo "ğŸŒ Configuring release environment..."
          
          gh api --method PUT "repos/$REPO/environments/release" \
            --input - << 'ENVJSON'
          {
            "wait_timer": 0,
            "prevent_self_review": false,
            "deployment_branch_policy": {
              "protected_branches": false,
              "custom_branch_policies": true
            }
          }
          ENVJSON
          
          # Allow any branch to deploy to release environment
          gh api --method POST "repos/$REPO/environments/release/deployment-branch-policies" \
            --input - << 'BRANCHJSON' 2>/dev/null || true
          {"name": "*"}
          BRANCHJSON
          
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # RULESET: Supplementary Release Gate (repo-level, adds to enterprise)
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          echo "ğŸ“‹ Configuring Release Gate ruleset..."
          
          # Check if ruleset exists
          RULESET_ID=$(gh api "repos/$REPO/rulesets" --jq '.[] | select(.name == "Release Gate" and .source_type == "Repository") | .id' 2>/dev/null || echo "")
          
          RULESET_JSON=$(cat << 'RULESETJSON'
          {
            "name": "Release Gate",
            "target": "branch",
            "enforcement": "active",
            "conditions": {
              "ref_name": {
                "include": ["~DEFAULT_BRANCH"],
                "exclude": []
              }
            },
            "rules": [
              {
                "type": "required_status_checks",
                "parameters": {
                  "strict_required_status_checks_policy": false,
                  "required_status_checks": [
                    {"context": "E2E Tests"}
                  ]
                }
              },
              {
                "type": "required_deployments",
                "parameters": {
                  "required_deployment_environments": ["release"]
                }
              }
            ],
            "bypass_actors": [
              {
                "actor_id": 5,
                "actor_type": "RepositoryRole",
                "bypass_mode": "always"
              }
            ]
          }
          RULESETJSON
          )
          
          if [ -n "$RULESET_ID" ]; then
            echo "  Updating existing ruleset #$RULESET_ID"
            echo "$RULESET_JSON" | gh api --method PUT "repos/$REPO/rulesets/$RULESET_ID" --input - > /dev/null
          else
            echo "  Creating new ruleset"
            echo "$RULESET_JSON" | gh api --method POST "repos/$REPO/rulesets" --input - > /dev/null
          fi
          
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # LABELS: Game-specific labels
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          echo "ğŸ“Œ Configuring labels..."
          
          declare -A LABELS=(
            ["jules-pr"]="7057ff:Created by Jules"
            ["e2e-failed"]="b60205:E2E tests failed"
            ["release-gate"]="0e8a16:Passed release gate"
            ["game/physics"]="1d76db:Physics system"
            ["game/ecs"]="1d76db:Entity Component System"
            ["game/rendering"]="1d76db:Rendering/graphics"
            ["game/audio"]="1d76db:Audio system"
          )
          
          for NAME in "${!LABELS[@]}"; do
            IFS=':' read -r COLOR DESC <<< "${LABELS[$NAME]}"
            gh label create "$NAME" --color "$COLOR" --description "$DESC" --repo "$REPO" 2>/dev/null || \
            gh label edit "$NAME" --color "$COLOR" --description "$DESC" --repo "$REPO" 2>/dev/null || true
          done
          
          echo "âœ… Repository sync complete"
          
          # Show current rulesets
          echo ""
          echo "ğŸ“‹ Active rulesets:"
          gh api "repos/$REPO/rulesets" --jq '.[] | "  - \(.name) (\(.source_type): \(.source))"'
