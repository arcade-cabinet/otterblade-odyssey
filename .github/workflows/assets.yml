# Asset Generation Workflow
# Generates missing game assets using AI (OpenAI GPT-Image-1, Google Veo 3.1, Imagen 3)
# Creates a PR with any generated assets

name: Generate Assets

on:
  workflow_dispatch:
    inputs:
      category:
        description: 'Asset category to generate (leave empty for all)'
        required: false
        type: choice
        options:
          - ''
          - sprites
          - enemies
          - cinematics
          - scenes
      force:
        description: 'Force regeneration of existing assets'
        required: false
        type: boolean
        default: false
      dry_run:
        description: 'Dry run (preview only, no generation)'
        required: false
        type: boolean
        default: false

env:
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

jobs:
  generate:
    name: Generate Assets
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Check API keys
        run: |
          if [ -z "$OPENAI_API_KEY" ] && [ -z "$GEMINI_API_KEY" ]; then
            echo "âŒ No API keys configured. Set OPENAI_API_KEY and/or GEMINI_API_KEY secrets."
            exit 1
          fi
          echo "âœ… API keys configured"
          [ -n "$OPENAI_API_KEY" ] && echo "  - OpenAI: configured"
          [ -n "$GEMINI_API_KEY" ] && echo "  - Gemini: configured"

      - name: Build dev-tools
        run: pnpm --filter @otterblade/dev-tools typecheck

      - name: Generate assets
        id: generate
        run: |
          ARGS=""
          
          if [ -n "${{ inputs.category }}" ]; then
            ARGS="$ARGS --category ${{ inputs.category }}"
          fi
          
          if [ "${{ inputs.force }}" == "true" ]; then
            ARGS="$ARGS --force"
          fi
          
          if [ "${{ inputs.dry_run }}" == "true" ]; then
            ARGS="$ARGS --dry-run"
          fi
          
          echo "Running: pnpm --filter @otterblade/dev-tools cli $ARGS"
          pnpm --filter @otterblade/dev-tools cli $ARGS
        continue-on-error: true

      - name: Check for changes
        id: changes
        if: inputs.dry_run != true
        run: |
          git add -A
          if git diff --cached --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "ðŸ“ No new assets generated"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ New assets detected:"
            git diff --cached --name-only
          fi

      - name: Create branch and commit
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Create branch name with timestamp
          BRANCH_NAME="assets/generated-$(date +%Y%m%d-%H%M%S)"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
          
          # Create and checkout branch
          git checkout -b "$BRANCH_NAME"
          
          # Commit changes
          CATEGORY="${{ inputs.category }}"
          if [ -z "$CATEGORY" ]; then
            CATEGORY="all categories"
          fi
          
          git commit -m "feat(assets): generate missing assets for $CATEGORY

          Generated by GitHub Actions workflow.
          
          Category: ${CATEGORY}
          Force: ${{ inputs.force }}
          
          Files generated:
          $(git diff --cached --name-only HEAD~1 | sed 's/^/- /')"

      - name: Push branch
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git push origin "$BRANCH_NAME"

      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const category = '${{ inputs.category }}' || 'all categories';
            const force = '${{ inputs.force }}' === 'true';
            
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `feat(assets): Generated assets for ${category}`,
              head: process.env.BRANCH_NAME,
              base: 'main',
              body: `## ðŸŽ¨ Asset Generation

            This PR was automatically created by the asset generation workflow.

            ### Configuration
            - **Category**: ${category}
            - **Force regeneration**: ${force}
            - **Triggered by**: @${{ github.actor }}

            ### Generated Assets
            See the file changes below for the list of generated assets.

            ### Review Checklist
            - [ ] All characters are anthropomorphic woodland animals (NO humans)
            - [ ] Visual style matches the storybook/painterly aesthetic
            - [ ] No neon, sci-fi, or horror elements
            - [ ] Protagonist (Finn) is consistently an otter warrior
            - [ ] Assets render correctly in-game

            ### Next Steps
            1. Review the generated assets for brand compliance
            2. If issues are found, close this PR and regenerate with updated prompts
            3. If assets look good, merge to main

            ---
            *Generated by [Asset Generation Workflow](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})*
            `,
            });
            
            console.log(`âœ… Created PR #${pr.number}: ${pr.html_url}`);
            
            // Add labels
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: ['assets', 'automated']
            });

      - name: Summary
        run: |
          echo "## ðŸŽ¨ Asset Generation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ inputs.dry_run }}" == "true" ]; then
            echo "ðŸ” **Dry run completed** - no assets were generated" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.changes.outputs.has_changes }}" == "true" ]; then
            echo "âœ… **Assets generated successfully**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "A pull request has been created with the new assets." >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸ“ **No new assets needed** - all assets are up to date" >> $GITHUB_STEP_SUMMARY
          fi
