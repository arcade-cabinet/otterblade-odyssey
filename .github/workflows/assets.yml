# Asset Generation Workflow
# Generates missing game assets using AI (OpenAI GPT-Image-1, Google Veo 3.1, Imagen 3)
# Creates a PR with any generated assets
#
# âš ï¸ COST WARNING: This workflow uses paid AI APIs.
# - OpenAI GPT-Image-1: ~$0.04-0.08 per image
# - Google Veo 3.1: ~$0.025 per second of video
# - Google Imagen 3: ~$0.03 per image
#
# Estimated costs per full generation:
# - Sprites (4 items): ~$0.16-0.32
# - Enemies (5 items): ~$0.20-0.40
# - Cinematics (11 items @ 8s each): ~$2.20
# - Scenes (9 items): ~$0.27

name: Generate Assets

on:
  workflow_dispatch:
    inputs:
      category:
        description: 'Asset category to generate (leave empty for all)'
        required: false
        type: choice
        options:
          - ''
          - sprites
          - enemies
          - cinematics
          - scenes
      force:
        description: 'Force regeneration of existing assets'
        required: false
        type: boolean
        default: false
      dry_run:
        description: 'Dry run (preview only, no generation)'
        required: false
        type: boolean
        default: false
      max_items:
        description: 'Maximum items to generate (0 = unlimited)'
        required: false
        type: number
        default: 5

# API keys are passed as environment variables but NOT logged
env:
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

jobs:
  generate:
    name: Generate Assets
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@9fd676a19091d4595eefd76e4bd31c97133911f1 # v4.2.0
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Validate API keys
        id: validate-keys
        run: |
          # Check if at least one API key is configured
          # Note: We do NOT echo or log API key values or presence in detail
          HAS_OPENAI=false
          HAS_GEMINI=false
          
          if [ -n "$OPENAI_API_KEY" ]; then
            HAS_OPENAI=true
          fi
          
          if [ -n "$GEMINI_API_KEY" ]; then
            HAS_GEMINI=true
          fi
          
          if [ "$HAS_OPENAI" = "false" ] && [ "$HAS_GEMINI" = "false" ]; then
            echo "::error::No API keys configured. Please set OPENAI_API_KEY and/or GEMINI_API_KEY secrets."
            exit 1
          fi
          
          # Determine which providers are available for category validation
          echo "openai_available=$HAS_OPENAI" >> $GITHUB_OUTPUT
          echo "gemini_available=$HAS_GEMINI" >> $GITHUB_OUTPUT

      - name: Validate category requirements
        run: |
          CATEGORY="${{ inputs.category }}"
          OPENAI_AVAILABLE="${{ steps.validate-keys.outputs.openai_available }}"
          GEMINI_AVAILABLE="${{ steps.validate-keys.outputs.gemini_available }}"
          
          # Validate that required API key is available for selected category
          if [ "$CATEGORY" = "sprites" ] || [ "$CATEGORY" = "enemies" ]; then
            if [ "$OPENAI_AVAILABLE" != "true" ]; then
              echo "::error::OpenAI API key required for $CATEGORY generation"
              exit 1
            fi
          fi
          
          if [ "$CATEGORY" = "cinematics" ] || [ "$CATEGORY" = "scenes" ]; then
            if [ "$GEMINI_AVAILABLE" != "true" ]; then
              echo "::error::Gemini API key required for $CATEGORY generation"
              exit 1
            fi
          fi
          
          echo "âœ“ API requirements validated for category: ${CATEGORY:-all}"

      - name: Build dev-tools
        run: pnpm --filter @otterblade/dev-tools typecheck

      - name: Generate assets
        id: generate
        run: |
          set -euo pipefail
          
          ARGS=""
          
          # Category is already validated via choice type
          if [ -n "${{ inputs.category }}" ]; then
            ARGS="$ARGS --category ${{ inputs.category }}"
          fi
          
          if [ "${{ inputs.force }}" == "true" ]; then
            ARGS="$ARGS --force"
          fi
          
          if [ "${{ inputs.dry_run }}" == "true" ]; then
            ARGS="$ARGS --dry-run"
          fi
          
          # Rate limiting: max items per run
          MAX_ITEMS="${{ inputs.max_items }}"
          if [ "$MAX_ITEMS" != "0" ] && [ -n "$MAX_ITEMS" ]; then
            ARGS="$ARGS --max-items $MAX_ITEMS"
          fi
          
          echo "::group::Asset Generation"
          pnpm --filter @otterblade/dev-tools cli $ARGS
          RESULT=$?
          echo "::endgroup::"
          
          if [ $RESULT -ne 0 ]; then
            echo "::warning::Asset generation completed with errors (exit code: $RESULT)"
            echo "generation_status=partial" >> $GITHUB_OUTPUT
          else
            echo "generation_status=success" >> $GITHUB_OUTPUT
          fi

      - name: Check for changes
        id: changes
        if: inputs.dry_run != true
        run: |
          git add -A
          if git diff --cached --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "ðŸ“ No new assets generated"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ New assets detected:"
            git diff --cached --name-only
          fi

      - name: Create branch and commit
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Create branch name with timestamp
          BRANCH_NAME="assets/generated-$(date +%Y%m%d-%H%M%S)"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
          
          # Create and checkout branch
          git checkout -b "$BRANCH_NAME"
          
          # Commit changes
          CATEGORY="${{ inputs.category }}"
          if [ -z "$CATEGORY" ]; then
            CATEGORY="all categories"
          fi
          
          git commit -m "feat(assets): generate missing assets for $CATEGORY

          Generated by GitHub Actions workflow.
          
          Category: ${CATEGORY}
          Force: ${{ inputs.force }}
          
          Files generated:
          $(git diff --cached --name-only HEAD~1 | sed 's/^/- /')"

      - name: Push branch
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git push origin "$BRANCH_NAME"

      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        with:
          script: |
            const category = '${{ inputs.category }}' || 'all categories';
            const force = '${{ inputs.force }}' === 'true';
            const maxItems = '${{ inputs.max_items }}';
            const generationStatus = '${{ steps.generate.outputs.generation_status }}';
            
            const statusNote = generationStatus === 'partial' 
              ? '\n\nâš ï¸ **Note**: Some assets may have failed to generate. Check the workflow logs for details.'
              : '';
            
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `feat(assets): Generated assets for ${category}`,
              head: process.env.BRANCH_NAME,
              base: 'main',
              body: `## ðŸŽ¨ Asset Generation

            This PR was automatically created by the asset generation workflow.${statusNote}

            ### Configuration
            - **Category**: ${category}
            - **Force regeneration**: ${force}
            - **Max items**: ${maxItems === '0' ? 'unlimited' : maxItems}
            - **Triggered by**: @${{ github.actor }}

            ### Generated Assets
            See the file changes below for the list of generated assets.

            ### Review Checklist
            - [ ] All characters are anthropomorphic woodland animals (NO humans)
            - [ ] Visual style matches the storybook/painterly aesthetic
            - [ ] No neon, sci-fi, or horror elements
            - [ ] Protagonist (Finn) is consistently an otter warrior
            - [ ] Assets render correctly in-game

            ### Next Steps
            1. Review the generated assets for brand compliance
            2. If issues are found, close this PR and regenerate with updated prompts
            3. If assets look good, merge to main

            ---
            *Generated by [Asset Generation Workflow](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})*
            `,
            });
            
            console.log(`âœ… Created PR #${pr.number}: ${pr.html_url}`);
            
            // Add labels
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: ['assets', 'automated']
            });

      - name: Summary
        run: |
          echo "## ðŸŽ¨ Asset Generation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ inputs.dry_run }}" == "true" ]; then
            echo "ðŸ” **Dry run completed** - no assets were generated" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.changes.outputs.has_changes }}" == "true" ]; then
            if [ "${{ steps.generate.outputs.generation_status }}" == "partial" ]; then
              echo "âš ï¸ **Assets generated with warnings** - some items may have failed" >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… **Assets generated successfully**" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "A pull request has been created with the new assets." >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸ“ **No new assets needed** - all assets are up to date" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- Category: ${{ inputs.category || 'all' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Force: ${{ inputs.force }}" >> $GITHUB_STEP_SUMMARY
          echo "- Max items: ${{ inputs.max_items }}" >> $GITHUB_STEP_SUMMARY
