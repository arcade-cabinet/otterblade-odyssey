name: Jules Completion Handler

# This workflow acts as a webhook handler for completed Jules sessions.
# It listens for a `repository_dispatch` event, which can be triggered
# by an external service when a Jules session finishes.

on:
  repository_dispatch:
    types: [jules-session-complete]

# No workflow-level permissions - all permissions defined at job level
permissions: {}

jobs:
  handle-completion:
    name: Handle Jules Session Completion
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          token: ${{ secrets.CI_GITHUB_TOKEN }}
          persist-credentials: false

      - name: Post Completion Comment
        env:
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
          SESSION_ID: ${{ github.event.client_payload.session_id }}
          OUTCOME: ${{ github.event.client_payload.outcome }}
          PR_NUMBER: ${{ github.event.client_payload.pr_number }}
          ISSUE_NUMBER: ${{ github.event.client_payload.issue_number }}
          AGENT_TYPE: ${{ github.event.client_payload.agent_type }}
          PR_URL: ${{ github.event.client_payload.pr_url }}
          REPO: ${{ github.repository }}
        run: |
          set -eo pipefail
          
          # Sanitize inputs to prevent command injection
          SAFE_SESSION_ID=$(echo "$SESSION_ID" | tr -cd 'a-zA-Z0-9_-')
          SAFE_PR_NUMBER=$(echo "$PR_NUMBER" | tr -cd '0-9')
          SAFE_ISSUE_NUMBER=$(echo "$ISSUE_NUMBER" | tr -cd '0-9')
          SAFE_AGENT_TYPE=$(echo "$AGENT_TYPE" | tr -cd 'a-zA-Z0-9_-')

          # Determine emoji based on agent type
          case "${SAFE_AGENT_TYPE}" in
            "bolt") EMOJI="âš¡"; AGENT_NAME="Bolt (Performance)" ;;
            "palette") EMOJI="ðŸŽ¨"; AGENT_NAME="Palette (UX)" ;;
            "scribe") EMOJI="ðŸ“š"; AGENT_NAME="Scribe (Docs)" ;;
            "sentinel") EMOJI="ðŸ›¡ï¸"; AGENT_NAME="Sentinel (Security)" ;;
            "bug-fixer") EMOJI="ðŸ›"; AGENT_NAME="Bug Fixer" ;;
            "cleanup") EMOJI="ðŸ§¹"; AGENT_NAME="Cleanup" ;;
            *) EMOJI="ðŸ¤–"; AGENT_NAME="General" ;;
          esac

          # Determine status icon and action
          case "${OUTCOME}" in
            "success") 
              STATUS_ICON="âœ…"
              STATUS_TEXT="Completed successfully"
              ;;
            "failure") 
              STATUS_ICON="âŒ"
              STATUS_TEXT="Failed - manual review needed"
              ;;
            "no_changes") 
              STATUS_ICON="â„¹ï¸"
              STATUS_TEXT="No changes needed"
              ;;
            "pr_created")
              STATUS_ICON="ðŸŽ‰"
              STATUS_TEXT="Pull request created"
              ;;
            *) 
              STATUS_ICON="â“"
              STATUS_TEXT="Unknown outcome"
              ;;
          esac

          # Construct the comment body
          COMMENT_BODY="### ${EMOJI} Jules ${AGENT_NAME} Session Complete

          | Field | Value |
          |-------|-------|
          | **Session ID** | \`${SAFE_SESSION_ID}\` |
          | **Agent** | ${AGENT_NAME} |
          | **Outcome** | ${STATUS_ICON} ${STATUS_TEXT} |
          "

          # Add PR link if available
          if [[ -n "${PR_URL}" ]]; then
            COMMENT_BODY="${COMMENT_BODY}
          | **Pull Request** | [View PR](${PR_URL}) |
          "
          fi

          COMMENT_BODY="${COMMENT_BODY}
          ---
          > ðŸ¤– *Automated by Jules*
          > 
          > This PR will be automatically reviewed and merged if approved.
          "

          if [[ -n "${SAFE_PR_NUMBER}" ]]; then
            # Comment on PR and add labels for triage
            gh pr comment "${SAFE_PR_NUMBER}" --repo "${REPO}" --body "$COMMENT_BODY"
            gh pr edit "${SAFE_PR_NUMBER}" --repo "${REPO}" --add-label "jules-pr,auto-triage" || true
            echo "Posted completion comment to PR #${SAFE_PR_NUMBER}"
          elif [[ -n "${SAFE_ISSUE_NUMBER}" ]]; then
            # Comment on Issue
            gh issue comment "${SAFE_ISSUE_NUMBER}" --repo "${REPO}" --body "$COMMENT_BODY"
            echo "Posted completion comment to Issue #${SAFE_ISSUE_NUMBER}"
          else
            echo "::notice::No PR or issue number provided - completion logged only"
            echo "Session completed: ${SAFE_SESSION_ID} - ${OUTCOME}"
          fi
