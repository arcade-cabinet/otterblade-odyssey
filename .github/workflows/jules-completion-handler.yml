name: Jules Completion Handler

# This workflow acts as a webhook handler for completed Jules sessions.
# It listens for a `repository_dispatch` event, which can be triggered
# by an external service when a Jules session finishes.

on:
  repository_dispatch:
    types: [jules-session-complete]

# No workflow-level permissions - all permissions defined at job level
permissions: {}

jobs:
  handle-completion:
    name: Handle Jules Session Completion
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          token: ${{ secrets.CI_GITHUB_TOKEN }}

      - name: Post Completion Comment
        env:
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
          SESSION_ID: ${{ github.event.client_payload.session_id }}
          OUTCOME: ${{ github.event.client_payload.outcome }}
          PR_NUMBER: ${{ github.event.client_payload.pr_number }}
          ISSUE_NUMBER: ${{ github.event.client_payload.issue_number }}
          AGENT_TYPE: ${{ github.event.client_payload.agent_type }}
          REPO: ${{ github.repository }}
        run: |
          set -eo pipefail

          # Determine emoji based on agent type
          case "${AGENT_TYPE}" in
            "bolt") EMOJI="‚ö°" ;;
            "palette") EMOJI="üé®" ;;
            "scribe") EMOJI="üìö" ;;
            "sentinel") EMOJI="üõ°Ô∏è" ;;
            "bug-fixer") EMOJI="üêõ" ;;
            "cleanup") EMOJI="üßπ" ;;
            *) EMOJI="ü§ñ" ;;
          esac

          # Determine status icon
          case "${OUTCOME}" in
            "success") STATUS_ICON="‚úÖ" ;;
            "failure") STATUS_ICON="‚ùå" ;;
            "no_changes") STATUS_ICON="‚ÑπÔ∏è" ;;
            *) STATUS_ICON="‚ùì" ;;
          esac

          # Construct the comment body
          COMMENT_BODY="### ${EMOJI} Jules Session Complete

          **Session ID:** \`${SESSION_ID}\`
          **Agent:** ${AGENT_TYPE:-General}
          **Outcome:** ${STATUS_ICON} ${OUTCOME}

          ---
          *Otterblade Odyssey - Automated by Jules*
          "

          if [[ -n "${PR_NUMBER}" ]]; then
            # Comment on PR
            gh pr comment "${PR_NUMBER}" --repo "${REPO}" --body "$COMMENT_BODY"
            echo "Posted completion comment to PR #${PR_NUMBER}"
          elif [[ -n "${ISSUE_NUMBER}" ]]; then
            # Comment on Issue
            gh issue comment "${ISSUE_NUMBER}" --repo "${REPO}" --body "$COMMENT_BODY"
            echo "Posted completion comment to Issue #${ISSUE_NUMBER}"
          else
            echo "::notice::No PR or issue number provided - completion logged only"
          fi
