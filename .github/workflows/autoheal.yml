# Autoheal - Unified CI Failure Resolution Pipeline
# Consolidates: ai-fixer.yml, ecosystem-fixer.yml
#
# Tier 1: Ollama (fast diagnosis) via control-center
# Tier 2: Claude (complex fixes / flaky test detection)

name: Autoheal

on:
  workflow_run:
    workflows: ["CI", "Build", "Test", "Lint"]
    types: [completed]
    branches-ignore: [main]

  workflow_call:
    inputs:
      run_id:
        description: 'Workflow run ID that failed'
        required: true
        type: string
      repository:
        description: 'Repository owner/name'
        required: true
        type: string
      branch:
        description: 'Branch name'
        required: true
        type: string
    secrets:
      CI_GITHUB_TOKEN:
        required: true
      ANTHROPIC_API_KEY:
        required: false
      OLLAMA_API_KEY:
        required: false

  workflow_dispatch:
    inputs:
      run_id:
        description: 'Workflow run ID'
        required: true
        type: string
      repository:
        description: 'Repository'
        required: true
        type: string
      branch:
        description: 'Branch'
        required: true
        type: string

permissions: {}

env:
  OLLAMA_HOST: https://ollama.com
  OLLAMA_MODEL: glm-4.6:cloud

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # VALIDATION: Security checks before processing
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  validate:
    name: Validate Source
    if: |
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'failure' &&
       github.event.workflow_run.pull_requests[0] &&
       !startsWith(github.event.workflow_run.head_branch, 'claude-fix-') &&
       !startsWith(github.event.workflow_run.head_branch, 'jules/')) ||
      github.event_name == 'workflow_call' ||
      github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
      actions: read
    outputs:
      is_trusted: ${{ steps.check.outputs.is_trusted }}
      head_branch: ${{ steps.check.outputs.head_branch }}
      pr_number: ${{ steps.check.outputs.pr_number }}
      is_fork: ${{ steps.check.outputs.is_fork }}
      target_repo: ${{ steps.check.outputs.target_repo }}
      target_run_id: ${{ steps.check.outputs.target_run_id }}
    steps:
      - name: Security validation
        id: check
        env:
          HEAD_BRANCH: ${{ github.event.workflow_run.head_branch || inputs.branch }}
          HEAD_REPO: ${{ github.event.workflow_run.head_repository.full_name }}
          BASE_REPO: ${{ github.event.workflow_run.repository.full_name || inputs.repository }}
          PR_NUMBER: ${{ github.event.workflow_run.pull_requests[0].number }}
          INPUT_REPO: ${{ inputs.repository || github.repository }}
          INPUT_RUN_ID: ${{ inputs.run_id || github.event.workflow_run.id }}
          EVENT_NAME: ${{ github.event_name }}
        run: |
          TARGET_REPO="$INPUT_REPO"
          TARGET_RUN_ID="$INPUT_RUN_ID"

          echo "target_repo=$TARGET_REPO" >> $GITHUB_OUTPUT
          echo "target_run_id=$TARGET_RUN_ID" >> $GITHUB_OUTPUT

          # Security: Reject PRs from forks
          if [[ "$EVENT_NAME" == "workflow_run" ]]; then
            if [[ "$HEAD_REPO" != "$BASE_REPO" ]]; then
              echo "::warning::PR from fork ($HEAD_REPO), skipping auto-fix"
              echo "is_trusted=false" >> $GITHUB_OUTPUT
              echo "is_fork=true" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi

          echo "is_fork=false" >> $GITHUB_OUTPUT

          # Validate branch name (prevent path traversal: no .., .git/, leading dots/slashes)
          if [[ ! "$HEAD_BRANCH" =~ ^[a-zA-Z0-9][a-zA-Z0-9/_-]*$ ]]; then
            echo "::error::Invalid branch name: must start with alphanumeric and contain only alphanumeric, /, _, or -"
            echo "is_trusted=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "is_trusted=true" >> $GITHUB_OUTPUT
          echo "head_branch=$HEAD_BRANCH" >> $GITHUB_OUTPUT
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT

      - name: Extract failure context
        if: steps.check.outputs.is_trusted == 'true'
        env:
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
          TARGET_REPO: ${{ steps.check.outputs.target_repo }}
          TARGET_BRANCH: ${{ steps.check.outputs.head_branch }}
          TARGET_RUN_ID: ${{ steps.check.outputs.target_run_id }}
        run: |
          # Get PR number
          PR_NUM=$(gh pr list --repo "$TARGET_REPO" --head "$TARGET_BRANCH" --json number --jq '.[0].number // empty' 2>/dev/null || echo "")
          echo "Found PR: $PR_NUM"

          # Get failure logs (truncated for context window)
          echo "ğŸ“‹ Fetching failure logs..."
          LOGS=$(gh run view "$TARGET_RUN_ID" --repo "$TARGET_REPO" --log-failed 2>&1 | tail -300 || echo "Could not fetch logs")

          # Sanitize logs to remove potential secrets (common patterns)
          # Note: GitHub Actions automatically masks registered secrets, but this adds defense in depth
          SANITIZED=$(echo "$LOGS" | sed -E \
            -e 's/(ghp|gho|ghu|ghs|ghr)_[A-Za-z0-9_]{36,}/<REDACTED_GITHUB_TOKEN>/g' \
            -e 's/(AKIA[0-9A-Z]{16})/<REDACTED_AWS_KEY>/g' \
            -e 's/([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12})/<REDACTED_UUID>/g' \
            -e 's/(sk-[A-Za-z0-9]{20,})/<REDACTED_API_KEY>/g' \
            -e 's/(Bearer [A-Za-z0-9._-]{20,})/<REDACTED_BEARER_TOKEN>/g')

          echo "$SANITIZED" > /tmp/failure.log

      - name: Upload failure log
        if: steps.check.outputs.is_trusted == 'true'
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: failure-log
          path: /tmp/failure.log
          retention-days: 1

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # TIER 1: Ollama Quick Fix (control-center)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build:
    needs: validate
    if: needs.validate.outputs.is_trusted == 'true'
    permissions:
      contents: read
    # Pin to specific commit SHA for stability (instead of @main)
    # Update periodically by checking: git ls-remote https://github.com/jbcom/control-center.git HEAD
    uses: jbcom/control-center/.github/workflows/control-center-build.yml@c3435f9986cfd70e51e385f6bbeaea79b26f26ee

  ollama-fix:
    name: Ollama Quick Fix
    needs: [validate, build]
    if: needs.validate.outputs.is_trusted == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      actions: read
    outputs:
      fix_applied: ${{ steps.fix.outputs.fix_applied }}
      needs_escalation: ${{ steps.fix.outputs.needs_escalation }}
    steps:
      - name: Download binary
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: control-center-binary
          path: /tmp
          run-id: ${{ github.run_id }}
          github-token: ${{ secrets.CI_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Download failure log
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: failure-log
          path: /tmp

      - name: Run Ollama fixer
        id: fix
        env:
          GITHUB_TOKEN: ${{ secrets.CI_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}
          OLLAMA_API_KEY: ${{ secrets.OLLAMA_API_KEY }}
          TARGET_REPO: ${{ needs.validate.outputs.target_repo }}
          TARGET_RUN_ID: ${{ needs.validate.outputs.target_run_id }}
          PR_NUM: ${{ needs.validate.outputs.pr_number }}
        run: |
          chmod +x /tmp/control-center

          # If no Ollama key, use simple log analysis and post suggestion
          if [ -z "$OLLAMA_API_KEY" ]; then
            echo "âš ï¸ No OLLAMA_API_KEY, posting manual suggestion..."
            FAILURE_LOG=$(head -200 /tmp/failure.log || echo "No logs available")

            if [ -n "$PR_NUM" ]; then
              gh pr comment "$PR_NUM" --repo "$TARGET_REPO" --body "$(cat <<EOF
          ## ğŸ”§ CI Fix Needed

          **Branch:** ${{ needs.validate.outputs.head_branch }}

          The CI workflow failed. Please review the logs and fix the issues.

          <details>
          <summary>Failure Log (last 200 lines)</summary>

          \`\`\`
          $FAILURE_LOG
          \`\`\`

          </details>

          ---
          <sub>ğŸ¤– Autoheal</sub>
          EOF
          )"
            fi
            echo "needs_escalation=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Run control-center fixer
          OUTPUT=$(/tmp/control-center fixer \
            --repo "$TARGET_REPO" \
            --run-id "$TARGET_RUN_ID" \
            --log-level info 2>&1) || true

          # Check if fix was applied
          if echo "$OUTPUT" | grep -q "fix applied\|commit created\|PR created"; then
            echo "fix_applied=true" >> $GITHUB_OUTPUT
            echo "needs_escalation=false" >> $GITHUB_OUTPUT
          else
            echo "fix_applied=false" >> $GITHUB_OUTPUT
            echo "needs_escalation=true" >> $GITHUB_OUTPUT
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # TIER 1B: Claude Flaky Test Detection (parallel)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  claude-flaky-detect:
    name: Claude Flaky Detection
    needs: validate
    if: needs.validate.outputs.is_trusted == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    concurrency:
      group: claude-flaky-${{ needs.validate.outputs.target_run_id }}
      cancel-in-progress: true
    permissions:
      contents: read
      actions: write
      pull-requests: write
      id-token: write
    outputs:
      is_flaky: ${{ steps.detect.outputs.is_flaky }}
      should_retry: ${{ steps.decide.outputs.should_retry }}
    steps:
      - name: Check API Key
        id: check-key
        run: |
          if [ -n "${{ secrets.ANTHROPIC_API_KEY }}" ]; then
            echo "available=true" >> $GITHUB_OUTPUT
          else
            echo "available=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout
        if: steps.check-key.outputs.available == 'true'
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          token: ${{ secrets.CI_GITHUB_TOKEN }}

      - name: Detect flaky test failures
        id: detect
        if: steps.check-key.outputs.available == 'true'
        uses: anthropics/claude-code-action@7145c3e0510bcdbdd29f67cc4a8c1958f1acfa2f # v1
        env:
          WORKFLOW_ID: ${{ needs.validate.outputs.target_run_id }}
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.CI_GITHUB_TOKEN }}
          allowed_bots: "cursor[bot],jules[bot],google-labs-jules[bot],copilot-swe-agent[bot],dependabot[bot],renovate[bot],github-actions[bot]"
          prompt: |
            Check the CI logs for workflow run ${{ env.WORKFLOW_ID }}.
            Use: gh run view ${{ env.WORKFLOW_ID }} --log-failed

            Determine if this looks like a flaky test failure by checking for:
            - Timeout errors
            - Race conditions
            - Network errors
            - "Expected X but got Y" intermittent failures
            - Tests that passed in previous commits

            Return:
            - is_flaky: true if likely flaky, false if real bug
            - confidence: number 0-1 indicating confidence level
            - summary: brief one-sentence explanation
          claude_args: |
            --json-schema '{"type":"object","properties":{"is_flaky":{"type":"boolean"},"confidence":{"type":"number","minimum":0,"maximum":1},"summary":{"type":"string"}},"required":["is_flaky","confidence","summary"]}'
            --allowedTools "Read,Glob,Grep,LS,Bash(gh:*),mcp__github_ci__get_ci_status,mcp__github_ci__get_workflow_run_details,mcp__github_ci__download_job_log"

      - name: Decide on retry
        id: decide
        if: steps.check-key.outputs.available == 'true'
        run: |
          OUTPUT='${{ steps.detect.outputs.structured_output }}'
          if ! echo "$OUTPUT" | jq empty 2>/dev/null; then
            echo "should_retry=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          IS_FLAKY=$(echo "$OUTPUT" | jq -r '.is_flaky // false')
          CONFIDENCE=$(echo "$OUTPUT" | jq -r '.confidence // 0')

          # Auto-retry only if flaky AND high confidence
          if [ "$IS_FLAKY" = "true" ] && [ "$(echo "$CONFIDENCE >= 0.7" | bc -l)" = "1" ]; then
            echo "should_retry=true" >> $GITHUB_OUTPUT
            echo "is_flaky=true" >> $GITHUB_OUTPUT
          else
            echo "should_retry=false" >> $GITHUB_OUTPUT
            echo "is_flaky=$IS_FLAKY" >> $GITHUB_OUTPUT
          fi

      - name: Retry workflow
        if: steps.decide.outputs.should_retry == 'true'
        env:
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
          HEAD_BRANCH: ${{ needs.validate.outputs.head_branch }}
          WORKFLOW_NAME: ${{ github.event.workflow_run.name }}
        run: |
          echo "ğŸ”„ Flaky test detected - triggering automatic retry..."
          gh workflow run "$WORKFLOW_NAME" --ref "$HEAD_BRANCH"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # TIER 2: Claude Deep Fix (for complex failures)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  claude-fix:
    name: Claude Deep Fix
    needs: [validate, ollama-fix, claude-flaky-detect]
    if: |
      always() &&
      needs.validate.outputs.is_trusted == 'true' &&
      needs.ollama-fix.outputs.needs_escalation == 'true' &&
      needs.claude-flaky-detect.outputs.should_retry != 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    concurrency:
      group: claude-fix-${{ needs.validate.outputs.target_run_id }}
      cancel-in-progress: false
    permissions:
      contents: write
      pull-requests: write
      actions: read
      issues: write
      id-token: write
    steps:
      - name: Check API Key
        id: check-key
        run: |
          if [ -n "${{ secrets.ANTHROPIC_API_KEY }}" ]; then
            echo "available=true" >> $GITHUB_OUTPUT
          else
            echo "::warning::ANTHROPIC_API_KEY not configured"
            echo "available=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout code
        if: steps.check-key.outputs.available == 'true'
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          ref: ${{ needs.validate.outputs.head_branch }}
          fetch-depth: 0
          token: ${{ secrets.CI_GITHUB_TOKEN }}

      - name: Setup git identity
        if: steps.check-key.outputs.available == 'true'
        run: |
          git config --global user.email "claude[bot]@users.noreply.github.com"
          git config --global user.name "claude[bot]"

      - name: Get failure details
        if: steps.check-key.outputs.available == 'true'
        id: failure
        env:
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
          TARGET_RUN_ID: ${{ needs.validate.outputs.target_run_id }}
        run: |
          LOGS=$(gh run view $TARGET_RUN_ID --log-failed 2>/dev/null | tail -200 || echo "Failed to fetch logs")
          echo "$LOGS" > /tmp/failure_logs.txt
          echo "logs_file=/tmp/failure_logs.txt" >> $GITHUB_OUTPUT

      - name: Fix with Claude
        if: steps.check-key.outputs.available == 'true'
        uses: anthropics/claude-code-action@7145c3e0510bcdbdd29f67cc4a8c1958f1acfa2f # v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.CI_GITHUB_TOKEN }}
          allowed_bots: "cursor[bot],copilot-swe-agent[bot],dependabot[bot],renovate[bot],github-actions[bot]"
          additional_permissions: |
            actions: read
          prompt: |
            Fix CI failure in ${{ needs.validate.outputs.target_repo }} PR #${{ needs.validate.outputs.pr_number }}.

            Failed workflow run ID: ${{ needs.validate.outputs.target_run_id }}
            Logs: /tmp/failure_logs.txt

            Diagnose the failure, implement a fix, and commit directly to this branch.
            Verify your fix passes the build.
          claude_args: |
            --allowedTools "Edit,MultiEdit,Write,Read,Glob,Grep,LS,Bash(git:*),Bash(pnpm:*),Bash(npm:*),Bash(gh:*),mcp__github__get_pull_request,mcp__github__get_pull_request_diff,mcp__github_ci__get_ci_status,mcp__github_ci__download_job_log"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # NOTIFY: Report status for fork PRs
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  notify-fork:
    name: Notify Fork PR
    needs: validate
    if: needs.validate.outputs.is_fork == 'true' && needs.validate.outputs.pr_number != ''
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Post notice
        env:
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
          TARGET_REPO: ${{ needs.validate.outputs.target_repo }}
          PR_NUM: ${{ needs.validate.outputs.pr_number }}
        run: |
          gh pr comment "$PR_NUM" --repo "$TARGET_REPO" --body "$(cat <<'EOF'
          âš ï¸ **Auto-fix unavailable for fork PRs**

          For security reasons, automatic CI fixes are disabled for fork PRs.
          Please fix the CI failure manually.
          EOF
          )"
